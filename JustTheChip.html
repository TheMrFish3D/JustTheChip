<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNC Speeds & Feeds Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/zustand@4.4.7/vanilla.mjs" type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }
        
        /* Tool type icons */
        .tool-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        /* Tooltip and Modal Styles */
        .tooltip-term {
            cursor: help;
            border-bottom: 1px dotted #6b7280;
            text-decoration: none;
        }
        
        .tooltip-term:hover {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        
        .result-value {
            cursor: help;
            position: relative;
        }
        
        .result-value:hover {
            background-color: #f3f4f6;
            border-radius: 2px;
            padding: 1px 2px;
        }
        
        .result-card-header:hover {
            background-color: #f9fafb;
            border-radius: 6px;
            padding: 4px;
            margin: -4px;
        }
        
        .tooltip-container {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .tooltip-header {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .parameter-range {
            user-select: none;
        }
        
        .detailed-modal-overlay {
            backdrop-filter: blur(2px);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .tooltip-container {
                max-width: 280px;
                font-size: 13px;
            }
            
            .detailed-modal-overlay .modal-content {
                margin: 10px;
                max-height: 95vh;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // ============= TOOL TYPES & CONFIGURATIONS =============
        
        const TOOL_TYPES = {
            endmill_flat: {
                name: 'Flat End Mill',
                icon: '🔧',
                parameters: ['diameter_mm', 'flutes', 'stickout_mm', 'shank_mm'],
                supportedCuts: ['slot', 'profile', 'adaptive', 'facing', 'plunge'],
                speedFactors: { slot: 1.0, profile: 1.2, adaptive: 1.3, facing: 1.1 }
            },
            endmill_ball: {
                name: 'Ball End Mill',
                icon: '⚪',
                parameters: ['diameter_mm', 'flutes', 'stickout_mm', 'shank_mm'],
                supportedCuts: ['profile', 'adaptive', '3d_contour'],
                speedFactors: { profile: 0.9, adaptive: 1.0, '3d_contour': 0.8 }
            },
            chamfer: {
                name: 'Chamfer Mill',
                icon: '⟋',
                parameters: ['diameter_mm', 'angle_deg', 'flutes', 'tip_diameter_mm'],
                supportedCuts: ['chamfer', 'deburr', 'countersink'],
                speedFactors: { chamfer: 1.2, deburr: 1.5, countersink: 1.0 }
            },
            vbit: {
                name: 'V-Bit / V-Carve',
                icon: '▼',
                parameters: ['angle_deg', 'tip_diameter_mm', 'max_diameter_mm', 'flutes'],
                supportedCuts: ['vcarve', 'engraving', 'chamfer'],
                speedFactors: { vcarve: 0.8, engraving: 1.0, chamfer: 0.9 }
            },
            facemill: {
                name: 'Face Mill (Insert)',
                icon: '⬡',
                parameters: ['diameter_mm', 'insert_count', 'insert_size_mm', 'max_doc_mm'],
                supportedCuts: ['facing', 'shoulder', 'ramping'],
                speedFactors: { facing: 1.4, shoulder: 1.2, ramping: 0.8 }
            },
            drill: {
                name: 'Drill Bit',
                icon: '⫸',
                parameters: ['diameter_mm', 'flutes', 'point_angle_deg', 'flute_length_mm'],
                supportedCuts: ['drilling', 'spot_drill', 'peck_drill'],
                speedFactors: { drilling: 1.0, spot_drill: 1.2, peck_drill: 0.9 }
            },
            threadmill: {
                name: 'Thread Mill',
                icon: '⟿',
                parameters: ['diameter_mm', 'pitch_mm', 'flutes', 'thread_depth_mm'],
                supportedCuts: ['thread_mill', 'helical'],
                speedFactors: { thread_mill: 0.7, helical: 0.8 }
            },
            tapered: {
                name: 'Tapered End Mill',
                icon: '⩙',
                parameters: ['tip_diameter_mm', 'taper_angle_deg', 'flutes', 'flute_length_mm'],
                supportedCuts: ['profile', '3d_contour', 'draft_angle'],
                speedFactors: { profile: 0.9, '3d_contour': 0.85, draft_angle: 1.0 }
            },
            boring: {
                name: 'Boring Bar',
                icon: '○',
                parameters: ['min_bore_diameter_mm', 'bar_diameter_mm', 'max_depth_mm', 'insert_type'],
                supportedCuts: ['boring', 'internal_profile'],
                speedFactors: { boring: 0.8, internal_profile: 0.7 }
            },
            slitting: {
                name: 'Slitting Saw',
                icon: '⊕',
                parameters: ['diameter_mm', 'width_mm', 'teeth', 'arbor_hole_mm'],
                supportedCuts: ['slitting', 'grooving'],
                speedFactors: { slitting: 0.6, grooving: 0.7 }
            }
        };

        const CUT_TYPES = {
            // Standard milling operations
            slot: { 
                name: 'Slotting', 
                ae_fraction: 1.0, 
                ap_fraction_range: [0.8, 1.0],
                toolTypes: ['endmill_flat', 'endmill_ball']
            },
            profile: { 
                name: 'Profile (Side)', 
                ae_fraction_range: [0.2, 0.4], 
                ap_fraction_range: [1.0, 1.5],
                toolTypes: ['endmill_flat', 'endmill_ball', 'tapered']
            },
            adaptive: { 
                name: 'Adaptive/Trochoidal', 
                ae_fraction_range: [0.1, 0.2], 
                ap_fraction_range: [1.5, 3.0],
                toolTypes: ['endmill_flat', 'endmill_ball']
            },
            facing: { 
                name: 'Facing', 
                ae_fraction_range: [0.6, 0.8], 
                ap_fraction_range: [0.1, 0.3],
                toolTypes: ['endmill_flat', 'facemill']
            },
            plunge: {
                name: 'Plunging',
                ae_fraction: 1.0,
                ap_fraction_range: [0.1, 0.3],
                toolTypes: ['endmill_flat']
            },
            
            // Specialized operations
            chamfer: {
                name: 'Chamfering',
                ae_fraction_range: [0.3, 0.5],
                ap_fraction_range: [0.5, 1.0],
                toolTypes: ['chamfer', 'vbit']
            },
            deburr: {
                name: 'Deburring',
                ae_fraction_range: [0.1, 0.2],
                ap_fraction_range: [0.1, 0.3],
                toolTypes: ['chamfer']
            },
            countersink: {
                name: 'Countersinking',
                ae_fraction: 1.0,
                ap_fraction_range: [0.2, 0.5],
                toolTypes: ['chamfer']
            },
            vcarve: {
                name: 'V-Carving',
                ae_fraction_range: [0.8, 1.0],
                ap_fraction_range: [0.5, 1.0],
                toolTypes: ['vbit']
            },
            engraving: {
                name: 'Engraving',
                ae_fraction_range: [0.5, 0.8],
                ap_fraction_range: [0.1, 0.3],
                toolTypes: ['vbit']
            },
            shoulder: {
                name: 'Shoulder Milling',
                ae_fraction_range: [0.3, 0.5],
                ap_fraction_range: [0.8, 1.2],
                toolTypes: ['facemill']
            },
            ramping: {
                name: 'Ramping',
                ae_fraction_range: [0.4, 0.6],
                ap_fraction_range: [0.2, 0.4],
                toolTypes: ['facemill']
            },
            drilling: {
                name: 'Drilling',
                ae_fraction: 1.0,
                ap_fraction_range: [2.0, 5.0],
                toolTypes: ['drill']
            },
            spot_drill: {
                name: 'Spot Drilling',
                ae_fraction: 1.0,
                ap_fraction_range: [0.2, 0.5],
                toolTypes: ['drill']
            },
            peck_drill: {
                name: 'Peck Drilling',
                ae_fraction: 1.0,
                ap_fraction_range: [0.5, 1.5],
                toolTypes: ['drill']
            },
            thread_mill: {
                name: 'Thread Milling',
                ae_fraction_range: [0.6, 0.8],
                ap_fraction_range: [0.3, 0.5],
                toolTypes: ['threadmill']
            },
            helical: {
                name: 'Helical Interpolation',
                ae_fraction_range: [0.4, 0.6],
                ap_fraction_range: [0.2, 0.4],
                toolTypes: ['threadmill']
            },
            '3d_contour': {
                name: '3D Contouring',
                ae_fraction_range: [0.1, 0.3],
                ap_fraction_range: [0.1, 0.5],
                toolTypes: ['endmill_ball', 'tapered']
            },
            draft_angle: {
                name: 'Draft Angle',
                ae_fraction_range: [0.2, 0.4],
                ap_fraction_range: [0.8, 1.5],
                toolTypes: ['tapered']
            },
            boring: {
                name: 'Boring',
                ae_fraction: 1.0,
                ap_fraction_range: [0.3, 0.6],
                toolTypes: ['boring']
            },
            internal_profile: {
                name: 'Internal Profiling',
                ae_fraction_range: [0.2, 0.4],
                ap_fraction_range: [0.5, 1.0],
                toolTypes: ['boring']
            },
            slitting: {
                name: 'Slitting',
                ae_fraction: 1.0,
                ap_fraction_range: [8.0, 15.0],
                toolTypes: ['slitting']
            },
            grooving: {
                name: 'Grooving',
                ae_fraction: 1.0,
                ap_fraction_range: [5.0, 10.0],
                toolTypes: ['slitting']
            }
        };

        // ============= DATA MODELS & PRESETS =============
        
        const MACHINE_PRESETS = {
            'light_hobby': {
                name: 'Light Hobby',
                rigidity_class: 'light_hobby',
                K_rigidity: 0.6,
                natural_frequency_hz: 30,  // Added for dynamic rigidity analysis
                damping_ratio: 0.05,      // Low damping in hobby machines
                aggressiveness: { radial: 0.6, axial: 0.6, feed: 0.7 },
                max_feed_mm_min: { x: 3000, y: 3000, z: 1000 },
                max_accel_mm_s2: { x: 200, y: 200, z: 100 },
                drive: { type: 'ballscrew', lead_mm_per_rev: 5, efficiency: 0.80 },
                motor: { type: 'stepper', rated_torque_Nm: 2.0, peak_torque_Nm: 2.0 }
            },
            'printnc': {
                name: 'PrintNC (baseline)',
                rigidity_class: 'printnc',
                K_rigidity: 1.0,
                natural_frequency_hz: 60,  // Added for dynamic rigidity analysis
                damping_ratio: 0.08,      // Better damping than light hobby
                aggressiveness: { radial: 1.0, axial: 1.0, feed: 1.0 },
                max_feed_mm_min: { x: 6000, y: 6000, z: 2000 },
                max_accel_mm_s2: { x: 500, y: 500, z: 200 },
                drive: { type: 'ballscrew', lead_mm_per_rev: 5, efficiency: 0.85 },
                motor: { type: 'stepper', rated_torque_Nm: 3.0, peak_torque_Nm: 3.0 }
            },
            'rigid_hobby': {
                name: 'Rigid Hobby',
                rigidity_class: 'rigid_hobby',
                K_rigidity: 1.2,
                natural_frequency_hz: 80,  // Added for dynamic rigidity analysis
                damping_ratio: 0.10,      // Good damping with heavier construction
                aggressiveness: { radial: 1.1, axial: 1.1, feed: 1.1 },
                max_feed_mm_min: { x: 8000, y: 8000, z: 3000 },
                max_accel_mm_s2: { x: 800, y: 800, z: 300 },
                drive: { type: 'ballscrew', lead_mm_per_rev: 5, efficiency: 0.90 },
                motor: { type: 'servo', rated_torque_Nm: 4.0, peak_torque_Nm: 6.0 }
            },
            'benchtop': {
                name: 'Benchtop Mill',
                rigidity_class: 'benchtop',
                K_rigidity: 1.5,
                natural_frequency_hz: 120, // Added for dynamic rigidity analysis
                damping_ratio: 0.12,      // Commercial-grade damping
                aggressiveness: { radial: 1.2, axial: 1.2, feed: 1.2 },
                max_feed_mm_min: { x: 10000, y: 10000, z: 4000 },
                max_accel_mm_s2: { x: 1000, y: 1000, z: 400 },
                drive: { type: 'ballscrew', lead_mm_per_rev: 5, efficiency: 0.92 },
                motor: { type: 'servo', rated_torque_Nm: 5.0, peak_torque_Nm: 8.0 }
            },
            'vmc_like': {
                name: 'VMC-like',
                rigidity_class: 'vmc_like',
                K_rigidity: 2.0,
                natural_frequency_hz: 200, // Added for dynamic rigidity analysis
                damping_ratio: 0.15,      // High damping in professional machines
                aggressiveness: { radial: 1.4, axial: 1.4, feed: 1.4 },
                max_feed_mm_min: { x: 15000, y: 15000, z: 6000 },
                max_accel_mm_s2: { x: 2000, y: 2000, z: 800 },
                drive: { type: 'ballscrew', lead_mm_per_rev: 10, efficiency: 0.95 },
                motor: { type: 'servo', rated_torque_Nm: 10.0, peak_torque_Nm: 15.0 }
            }
        };

        const MATERIALS = {
            'al_6061_t6': {
                id: 'al_6061_t6',
                name: 'Aluminum 6061-T6',
                category: 'metal',
                sfm_range: [250, 1000],
                vc_range: [76, 305],
                fz_mm_per_tooth_by_diameter: [
                    { max_d_mm: 3, range: [0.005, 0.02] },
                    { max_d_mm: 6, range: [0.015, 0.04] },
                    { max_d_mm: 10, range: [0.03, 0.07] },
                    { max_d_mm: 20, range: [0.05, 0.10] }
                ],
                // Tool-specific chipload multipliers
                toolChiploadFactors: {
                    endmill_flat: 1.0,
                    endmill_ball: 0.8,
                    chamfer: 0.7,
                    vbit: 0.6,
                    facemill: 1.3,
                    drill: 0.5,
                    threadmill: 0.4,
                    tapered: 0.85,
                    boring: 0.7,
                    slitting: 0.6
                },
                max_radial_engagement_fraction: { 
                    slot: 1.0, profile: 0.35, adaptive: 0.15, facing: 0.75,
                    chamfer: 0.4, vcarve: 0.8, drilling: 1.0, boring: 1.0
                },
                max_axial_per_pass_D: { 
                    slot: 1.0, profile: 1.5, adaptive: 2.0, facing: 0.2,
                    chamfer: 0.5, vcarve: 0.8, drilling: 3.0, boring: 0.5
                },
                chip_thinning: { enable_below_fraction: 0.5 },
                force_coeff_KN_mm2: 0.7,  // Validated per ASM Metals Handbook Vol 16
                specific_cutting_energy_J_mm3: 0.7,  // Added physics-based power calculation
                notes: 'Use coolant/mist; clear chips aggressively.'
            },
            'al_7075_t6': {
                id: 'al_7075_t6',
                name: 'Aluminum 7075-T6',
                category: 'metal',
                sfm_range: [200, 800],
                vc_range: [61, 244],
                fz_mm_per_tooth_by_diameter: [
                    { max_d_mm: 3, range: [0.004, 0.018] },
                    { max_d_mm: 6, range: [0.012, 0.035] },
                    { max_d_mm: 10, range: [0.025, 0.06] },
                    { max_d_mm: 20, range: [0.04, 0.09] }
                ],
                toolChiploadFactors: {
                    endmill_flat: 1.0,
                    endmill_ball: 0.75,
                    chamfer: 0.65,
                    vbit: 0.55,
                    facemill: 1.25,
                    drill: 0.45,
                    threadmill: 0.35,
                    tapered: 0.8,
                    boring: 0.65,
                    slitting: 0.55
                },
                max_radial_engagement_fraction: { 
                    slot: 1.0, profile: 0.30, adaptive: 0.12, facing: 0.7,
                    chamfer: 0.35, vcarve: 0.75, drilling: 1.0, boring: 1.0
                },
                max_axial_per_pass_D: { 
                    slot: 0.8, profile: 1.2, adaptive: 1.8, facing: 0.15,
                    chamfer: 0.4, vcarve: 0.6, drilling: 2.5, boring: 0.4
                },
                chip_thinning: { enable_below_fraction: 0.5 },
                force_coeff_KN_mm2: 1.1,
                notes: 'Harder than 6061; watch for work hardening.'
            },
            'brass': {
                id: 'brass',
                name: 'Brass (C360)',
                category: 'metal',
                sfm_range: [200, 600],
                vc_range: [61, 183],
                fz_mm_per_tooth_by_diameter: [
                    { max_d_mm: 3, range: [0.006, 0.025] },
                    { max_d_mm: 6, range: [0.02, 0.05] },
                    { max_d_mm: 10, range: [0.04, 0.08] },
                    { max_d_mm: 20, range: [0.06, 0.12] }
                ],
                toolChiploadFactors: {
                    endmill_flat: 1.0,
                    endmill_ball: 0.85,
                    chamfer: 0.75,
                    vbit: 0.65,
                    facemill: 1.4,
                    drill: 0.6,
                    threadmill: 0.45,
                    tapered: 0.9,
                    boring: 0.75,
                    slitting: 0.7
                },
                max_radial_engagement_fraction: { 
                    slot: 1.0, profile: 0.40, adaptive: 0.20, facing: 0.8,
                    chamfer: 0.45, vcarve: 0.85, drilling: 1.0, boring: 1.0
                },
                max_axial_per_pass_D: { 
                    slot: 1.2, profile: 1.8, adaptive: 2.5, facing: 0.25,
                    chamfer: 0.6, vcarve: 1.0, drilling: 3.5, boring: 0.6
                },
                chip_thinning: { enable_below_fraction: 0.5 },
                force_coeff_KN_mm2: 0.7,
                notes: 'Free machining; watch for grabbing with aggressive cuts.'
            },
            'steel_mild': {
                id: 'steel_mild',
                name: 'Mild Steel (A36)',
                category: 'metal',
                sfm_range: [80, 250],
                vc_range: [24, 76],
                fz_mm_per_tooth_by_diameter: [
                    { max_d_mm: 3, range: [0.003, 0.012] },
                    { max_d_mm: 6, range: [0.010, 0.025] },
                    { max_d_mm: 10, range: [0.020, 0.04] },
                    { max_d_mm: 20, range: [0.03, 0.06] }
                ],
                toolChiploadFactors: {
                    endmill_flat: 1.0,
                    endmill_ball: 0.7,
                    chamfer: 0.6,
                    vbit: 0.5,
                    facemill: 1.2,
                    drill: 0.4,
                    threadmill: 0.3,
                    tapered: 0.75,
                    boring: 0.6,
                    slitting: 0.5
                },
                max_radial_engagement_fraction: { 
                    slot: 1.0, profile: 0.25, adaptive: 0.10, facing: 0.6,
                    chamfer: 0.3, vcarve: 0.6, drilling: 1.0, boring: 1.0
                },
                max_axial_per_pass_D: { 
                    slot: 0.5, profile: 0.8, adaptive: 1.2, facing: 0.1,
                    chamfer: 0.3, vcarve: 0.4, drilling: 2.0, boring: 0.3
                },
                chip_thinning: { enable_below_fraction: 0.5 },
                force_coeff_KN_mm2: 1.8,  // Corrected from 1.8->1.8 (already correct per ASM)
                specific_cutting_energy_J_mm3: 2.8,  // Added for physics-based power calculation
                notes: 'Requires rigid setup; use coolant.'
            },
            'steel_1045': {
                id: 'steel_1045',
                name: 'Steel 1045',
                category: 'metal',
                sfm_range: [60, 200],
                vc_range: [18, 61],
                fz_mm_per_tooth_by_diameter: [
                    { max_d_mm: 3, range: [0.002, 0.010] },
                    { max_d_mm: 6, range: [0.008, 0.020] },
                    { max_d_mm: 10, range: [0.015, 0.035] },
                    { max_d_mm: 20, range: [0.025, 0.05] }
                ],
                toolChiploadFactors: {
                    endmill_flat: 1.0,
                    endmill_ball: 0.65,
                    chamfer: 0.55,
                    vbit: 0.45,
                    facemill: 1.15,
                    drill: 0.35,
                    threadmill: 0.25,
                    tapered: 0.7,
                    boring: 0.55,
                    slitting: 0.45
                },
                max_radial_engagement_fraction: { 
                    slot: 1.0, profile: 0.20, adaptive: 0.08, facing: 0.5,
                    chamfer: 0.25, vcarve: 0.5, drilling: 1.0, boring: 1.0
                },
                max_axial_per_pass_D: { 
                    slot: 0.4, profile: 0.6, adaptive: 1.0, facing: 0.08,
                    chamfer: 0.25, vcarve: 0.3, drilling: 1.5, boring: 0.25
                },
                chip_thinning: { enable_below_fraction: 0.5 },
                force_coeff_KN_mm2: 2.2,
                notes: 'Medium carbon steel; watch tool wear.'
            },
            'ss_304': {
                id: 'ss_304',
                name: '304 Stainless Steel',
                category: 'metal',
                sfm_range: [40, 150],
                vc_range: [12, 46],
                fz_mm_per_tooth_by_diameter: [
                    { max_d_mm: 3, range: [0.002, 0.008] },
                    { max_d_mm: 6, range: [0.006, 0.015] },
                    { max_d_mm: 10, range: [0.012, 0.025] },
                    { max_d_mm: 20, range: [0.020, 0.04] }
                ],
                toolChiploadFactors: {
                    endmill_flat: 1.0,
                    endmill_ball: 0.6,
                    chamfer: 0.5,
                    vbit: 0.4,
                    facemill: 1.1,
                    drill: 0.3,
                    threadmill: 0.2,
                    tapered: 0.65,
                    boring: 0.5,
                    slitting: 0.4
                },
                max_radial_engagement_fraction: { 
                    slot: 1.0, profile: 0.15, adaptive: 0.06, facing: 0.4,
                    chamfer: 0.2, vcarve: 0.4, drilling: 1.0, boring: 1.0
                },
                max_axial_per_pass_D: { 
                    slot: 0.3, profile: 0.5, adaptive: 0.8, facing: 0.06,
                    chamfer: 0.2, vcarve: 0.25, drilling: 1.0, boring: 0.2
                },
                chip_thinning: { enable_below_fraction: 0.5 },
                force_coeff_KN_mm2: 2.0,  // Corrected from 2.5->2.0 per Sandvik data  
                specific_cutting_energy_J_mm3: 4.2,  // Added for physics-based power calculation
                notes: 'Work hardens easily; maintain consistent chipload.'
            },
            'titanium': {
                id: 'titanium',
                name: 'Titanium (Ti-6Al-4V)',
                category: 'metal',
                sfm_range: [30, 120],
                vc_range: [9, 37],
                fz_mm_per_tooth_by_diameter: [
                    { max_d_mm: 3, range: [0.001, 0.006] },
                    { max_d_mm: 6, range: [0.004, 0.012] },
                    { max_d_mm: 10, range: [0.008, 0.020] },
                    { max_d_mm: 20, range: [0.015, 0.03] }
                ],
                toolChiploadFactors: {
                    endmill_flat: 1.0,
                    endmill_ball: 0.55,
                    chamfer: 0.45,
                    vbit: 0.35,
                    facemill: 1.05,
                    drill: 0.25,
                    threadmill: 0.18,
                    tapered: 0.6,
                    boring: 0.45,
                    slitting: 0.35
                },
                max_radial_engagement_fraction: { 
                    slot: 1.0, profile: 0.10, adaptive: 0.04, facing: 0.3,
                    chamfer: 0.15, vcarve: 0.3, drilling: 1.0, boring: 1.0
                },
                max_axial_per_pass_D: { 
                    slot: 0.2, profile: 0.3, adaptive: 0.5, facing: 0.04,
                    chamfer: 0.15, vcarve: 0.2, drilling: 0.75, boring: 0.15
                },
                chip_thinning: { enable_below_fraction: 0.5 },
                force_coeff_KN_mm2: 2.5,  // Corrected from 3.0->2.5 per Kennametal data
                specific_cutting_energy_J_mm3: 5.5,  // Added for physics-based power calculation
                notes: 'Extremely tough; requires sharp tools and flood coolant.'
            },
            'acrylic': {
                id: 'acrylic',
                name: 'Acrylic (PMMA)',
                category: 'plastic',
                sfm_range: [300, 1200],
                vc_range: [91, 366],
                fz_mm_per_tooth_by_diameter: [
                    { max_d_mm: 3, range: [0.01, 0.04] },
                    { max_d_mm: 6, range: [0.03, 0.08] },
                    { max_d_mm: 10, range: [0.06, 0.12] },
                    { max_d_mm: 20, range: [0.10, 0.20] }
                ],
                toolChiploadFactors: {
                    endmill_flat: 1.0,
                    endmill_ball: 0.9,
                    chamfer: 0.8,
                    vbit: 0.7,
                    facemill: 1.5,
                    drill: 0.7,
                    threadmill: 0.5,
                    tapered: 0.95,
                    boring: 0.8,
                    slitting: 0.85
                },
                max_radial_engagement_fraction: { 
                    slot: 1.0, profile: 0.50, adaptive: 0.25, facing: 0.85,
                    chamfer: 0.55, vcarve: 0.9, drilling: 1.0, boring: 1.0
                },
                max_axial_per_pass_D: { 
                    slot: 2.0, profile: 3.0, adaptive: 4.0, facing: 0.3,
                    chamfer: 1.0, vcarve: 1.5, drilling: 5.0, boring: 1.0
                },
                chip_thinning: { enable_below_fraction: 0.5 },
                force_coeff_KN_mm2: 0.3,
                specific_cutting_energy_J_mm3: 0.1,  // Added for physics-based power calculation
                notes: 'Single flute for best finish; watch for melting.'
            },
            'polycarbonate': {
                id: 'polycarbonate',
                name: 'Polycarbonate',
                category: 'plastic',
                sfm_range: [250, 1000],
                vc_range: [76, 305],
                fz_mm_per_tooth_by_diameter: [
                    { max_d_mm: 3, range: [0.008, 0.035] },
                    { max_d_mm: 6, range: [0.025, 0.07] },
                    { max_d_mm: 10, range: [0.05, 0.10] },
                    { max_d_mm: 20, range: [0.08, 0.16] }
                ],
                toolChiploadFactors: {
                    endmill_flat: 1.0,
                    endmill_ball: 0.85,
                    chamfer: 0.75,
                    vbit: 0.65,
                    facemill: 1.4,
                    drill: 0.65,
                    threadmill: 0.45,
                    tapered: 0.9,
                    boring: 0.75,
                    slitting: 0.8
                },
                max_radial_engagement_fraction: { 
                    slot: 1.0, profile: 0.45, adaptive: 0.20, facing: 0.8,
                    chamfer: 0.5, vcarve: 0.85, drilling: 1.0, boring: 1.0
                },
                max_axial_per_pass_D: { 
                    slot: 1.8, profile: 2.5, adaptive: 3.5, facing: 0.25,
                    chamfer: 0.8, vcarve: 1.2, drilling: 4.5, boring: 0.8
                },
                chip_thinning: { enable_below_fraction: 0.5 },
                force_coeff_KN_mm2: 0.4,
                specific_cutting_energy_J_mm3: 0.15,  // Added for physics-based power calculation
                notes: 'Tougher than acrylic; good chip evacuation needed.'
            },
            'mdf': {
                id: 'mdf',
                name: 'MDF',
                category: 'wood',
                sfm_range: [400, 2000],
                vc_range: [122, 610],
                fz_mm_per_tooth_by_diameter: [
                    { max_d_mm: 3, range: [0.02, 0.08] },
                    { max_d_mm: 6, range: [0.05, 0.15] },
                    { max_d_mm: 10, range: [0.10, 0.25] },
                    { max_d_mm: 20, range: [0.15, 0.35] }
                ],
                toolChiploadFactors: {
                    endmill_flat: 1.0,
                    endmill_ball: 0.95,
                    chamfer: 0.9,
                    vbit: 0.85,
                    facemill: 1.6,
                    drill: 0.8,
                    threadmill: 0.6,
                    tapered: 1.0,
                    boring: 0.85,
                    slitting: 0.95
                },
                max_radial_engagement_fraction: { 
                    slot: 1.0, profile: 0.60, adaptive: 0.30, facing: 0.9,
                    chamfer: 0.65, vcarve: 0.95, drilling: 1.0, boring: 1.0
                },
                max_axial_per_pass_D: { 
                    slot: 3.0, profile: 4.0, adaptive: 5.0, facing: 0.4,
                    chamfer: 1.5, vcarve: 2.0, drilling: 6.0, boring: 1.5
                },
                chip_thinning: { enable_below_fraction: 0.5 },
                force_coeff_KN_mm2: 0.15,
                specific_cutting_energy_J_mm3: 0.05,  // Added for physics-based power calculation
                notes: 'Dust collection essential; compression bits for clean edges.'
            },
            'hardwood': {
                id: 'hardwood',
                name: 'Hardwood (Generic)',
                category: 'wood',
                sfm_range: [300, 1500],
                vc_range: [91, 457],
                fz_mm_per_tooth_by_diameter: [
                    { max_d_mm: 3, range: [0.015, 0.06] },
                    { max_d_mm: 6, range: [0.04, 0.12] },
                    { max_d_mm: 10, range: [0.08, 0.20] },
                    { max_d_mm: 20, range: [0.12, 0.30] }
                ],
                toolChiploadFactors: {
                    endmill_flat: 1.0,
                    endmill_ball: 0.9,
                    chamfer: 0.85,
                    vbit: 0.8,
                    facemill: 1.5,
                    drill: 0.75,
                    threadmill: 0.55,
                    tapered: 0.95,
                    boring: 0.8,
                    slitting: 0.9
                },
                max_radial_engagement_fraction: { 
                    slot: 1.0, profile: 0.50, adaptive: 0.25, facing: 0.85,
                    chamfer: 0.55, vcarve: 0.9, drilling: 1.0, boring: 1.0
                },
                max_axial_per_pass_D: { 
                    slot: 2.0, profile: 3.0, adaptive: 4.0, facing: 0.35,
                    chamfer: 1.2, vcarve: 1.8, drilling: 5.0, boring: 1.2
                },
                chip_thinning: { enable_below_fraction: 0.5 },
                force_coeff_KN_mm2: 0.25,
                specific_cutting_energy_J_mm3: 0.08,  // Added for physics-based power calculation
                notes: 'Watch for grain direction; sharp tools essential.'
            }
        };

        // ============= INDUSTRY TERMINOLOGY DATABASE =============
        
        const INDUSTRY_TERMS = {
            // Cutting Parameters
            'RPM': {
                fullName: 'Revolutions Per Minute',
                description: 'Spindle rotational speed - the number of complete rotations the spindle makes in one minute.',
                formula: 'RPM = (1000 × Vc) / (π × D)',
                variables: {
                    'Vc': 'Cutting speed in m/min',
                    'D': 'Tool diameter in mm',
                    'π': 'Mathematical constant pi (≈3.14159)'
                },
                safetyNotes: 'Exceeding max RPM can cause tool failure or spindle damage. Too low RPM may cause work hardening.',
                typicalRanges: {
                    'small_tools': '15,000-30,000 RPM (1-6mm tools)',
                    'medium_tools': '8,000-20,000 RPM (6-12mm tools)', 
                    'large_tools': '3,000-12,000 RPM (12mm+ tools)'
                }
            },
            'DOC': {
                fullName: 'Depth of Cut (Axial)',
                description: 'The thickness of material removed in the cutting direction (along tool axis).',
                formula: 'DOC = Material thickness per pass',
                safetyNotes: 'Excessive DOC increases cutting forces exponentially and may break the tool.',
                typicalRanges: {
                    'conservative': '10-30% of tool diameter',
                    'moderate': '30-50% of tool diameter',
                    'aggressive': '50-100% of tool diameter (use with caution)'
                }
            },
            'WOC': {
                fullName: 'Width of Cut (Radial)',
                description: 'The width of material engaged by the tool perpendicular to the cutting direction.',
                formula: 'WOC = ae = Step-over distance',
                safetyNotes: 'Full-width cuts (100% WOC) create maximum stress. Reduce for better tool life.',
                typicalRanges: {
                    'finishing': '5-20% of tool diameter',
                    'semi_roughing': '20-50% of tool diameter',
                    'slotting': '100% of tool diameter'
                }
            },
            'Chipload': {
                fullName: 'Feed per Tooth',
                description: 'The thickness of material each cutting edge removes per revolution.',
                formula: 'fz = Feed Rate / (RPM × Number of Flutes)',
                variables: {
                    'fz': 'Chipload in mm/tooth',
                    'Feed Rate': 'Table feed in mm/min',
                    'RPM': 'Spindle speed',
                    'Flutes': 'Number of cutting edges'
                },
                safetyNotes: 'Too low causes rubbing and work hardening. Too high breaks the tool.',
                typicalRanges: {
                    'aluminum': '0.05-0.25 mm/tooth',
                    'steel': '0.02-0.15 mm/tooth',
                    'plastic': '0.1-0.4 mm/tooth'
                }
            },
            'MRR': {
                fullName: 'Material Removal Rate',
                description: 'Volume of material removed per minute - measure of machining efficiency.',
                formula: 'MRR = WOC × DOC × Feed Rate',
                variables: {
                    'WOC': 'Width of cut (ae)',
                    'DOC': 'Depth of cut (ap)', 
                    'Feed Rate': 'Table feed speed'
                },
                safetyNotes: 'Higher MRR generates more heat and requires more power.',
                units: 'mm³/min or cm³/min'
            },
            'SFM': {
                fullName: 'Surface Feet per Minute',
                description: 'Linear speed of the tool edge relative to the workpiece (Imperial units).',
                formula: 'SFM = (π × D × RPM) / 12',
                variables: {
                    'D': 'Tool diameter in inches',
                    'RPM': 'Spindle speed'
                },
                metricEquivalent: 'Cutting Speed (Vc) in m/min'
            },
            'Vc': {
                fullName: 'Cutting Speed',
                description: 'Linear speed of the tool edge relative to the workpiece (Metric units).',
                formula: 'Vc = (π × D × RPM) / 1000',
                variables: {
                    'D': 'Tool diameter in mm',
                    'RPM': 'Spindle speed'
                },
                units: 'm/min',
                imperialEquivalent: 'Surface Feet per Minute (SFM)'
            },
            'Deflection': {
                fullName: 'Tool Deflection',
                description: 'Bending of the tool under cutting forces, affecting accuracy and surface finish.',
                formula: 'δ = (F × L³) / (3 × E × I) + (k × F × L) / (G × A) + F × Compliance',
                variables: {
                    'F': 'Cutting force in N',
                    'L': 'Tool stickout length',
                    'E': 'Young\'s modulus (material stiffness)',
                    'I': 'Second moment of area',
                    'G': 'Shear modulus',
                    'A': 'Cross-sectional area',
                    'Compliance': 'Tool holder + spindle compliance'
                },
                safetyNotes: 'Excessive deflection causes poor surface finish, dimensional errors, and tool chatter.',
                acceptableLimits: {
                    'precision': '< 0.01mm',
                    'general': '< 0.02mm', 
                    'rough': '< 0.05mm'
                }
            },
            'Power': {
                fullName: 'Spindle Power Required',
                description: 'Electrical power needed from the spindle motor to maintain cutting operations.',
                formula: 'P = (SEC × MRR) / η + P_losses',
                variables: {
                    'SEC': 'Specific cutting energy (J/mm³)',
                    'MRR': 'Material removal rate (mm³/min)',
                    'η': 'Overall machine efficiency (0.7-0.9)',
                    'P_losses': 'Bearing, drive, and spindle losses'
                },
                safetyNotes: 'Exceeding spindle power causes motor stall, poor surface finish, and potential damage.',
                units: 'Watts (W) or kilowatts (kW)'
            },
            'Force': {
                fullName: 'Cutting Force',
                description: 'Mechanical force exerted by the tool on the workpiece during cutting.',
                formula: 'F = K × A × adjustment_factors',
                variables: {
                    'K': 'Material force coefficient (N/mm²)',
                    'A': 'Chip cross-sectional area (mm²)',
                    'adjustment_factors': 'Tool geometry, coating, and engagement corrections'
                },
                safetyNotes: 'High cutting forces can cause tool breakage, workpiece deflection, and machine vibration.',
                units: 'Newtons (N)'
            }
        };

        // ============= TOOLTIP AND MODAL SYSTEM =============
        
        const TooltipSystem = {
            createTooltip: function(element, content, type = 'basic') {
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip-container';
                tooltip.style.cssText = `
                    position: absolute;
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 12px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                    max-width: 350px;
                    z-index: 1000;
                    font-size: 14px;
                    line-height: 1.4;
                    display: none;
                `;
                
                if (type === 'parameter') {
                    tooltip.innerHTML = this.createParameterTooltip(content);
                } else if (type === 'formula') {
                    tooltip.innerHTML = this.createFormulaTooltip(content);
                } else {
                    tooltip.innerHTML = content;
                }
                
                document.body.appendChild(tooltip);
                
                element.addEventListener('mouseenter', (e) => {
                    this.positionTooltip(tooltip, e);
                    tooltip.style.display = 'block';
                });
                
                element.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
                
                element.addEventListener('mousemove', (e) => {
                    this.positionTooltip(tooltip, e);
                });
                
                return tooltip;
            },
            
            createParameterTooltip: function(paramData) {
                const { name, value, min, max, recommended, unit, status } = paramData;
                const statusColor = status === 'danger' ? '#ef4444' : 
                                  status === 'warning' ? '#f59e0b' : 
                                  status === 'good' ? '#10b981' : '#6b7280';
                
                const percentage = Math.min(Math.max((value - min) / (max - min) * 100, 0), 100);
                const recommendedPerc = Math.min(Math.max((recommended - min) / (max - min) * 100, 0), 100);
                
                return `
                    <div class="tooltip-header">
                        <strong>${name}</strong>
                        <span style="color: ${statusColor}; margin-left: 8px;">${value}${unit}</span>
                    </div>
                    <div class="parameter-range" style="margin: 8px 0;">
                        <div style="position: relative; height: 20px; background: #f3f4f6; border-radius: 10px; overflow: hidden;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; background: linear-gradient(to right, #ef4444, #f59e0b, #10b981); width: 100%;"></div>
                            <div style="position: absolute; left: ${recommendedPerc}%; top: 0; width: 2px; height: 100%; background: white; border: 1px solid #333;"></div>
                            <div style="position: absolute; left: ${percentage}%; top: 0; width: 8px; height: 100%; background: ${statusColor}; border: 2px solid white; margin-left: -4px; border-radius: 50%;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #6b7280; margin-top: 4px;">
                            <span>Min: ${min}${unit}</span>
                            <span>Rec: ${recommended}${unit}</span>
                            <span>Max: ${max}${unit}</span>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #6b7280;">
                        ${this.getParameterAdvice(name, value, recommended, status)}
                    </div>
                `;
            },
            
            createFormulaTooltip: function(termKey) {
                const term = INDUSTRY_TERMS[termKey];
                if (!term) return `<div>No information available for ${termKey}</div>`;
                
                return `
                    <div class="tooltip-header">
                        <strong>${termKey}</strong> - ${term.fullName}
                    </div>
                    <div style="margin: 8px 0; color: #374151;">
                        ${term.description}
                    </div>
                    ${term.formula ? `
                        <div style="background: #f9fafb; padding: 8px; border-radius: 4px; margin: 8px 0; font-family: monospace;">
                            <strong>Formula:</strong> ${term.formula}
                        </div>
                    ` : ''}
                    ${term.variables ? `
                        <div style="margin: 8px 0;">
                            <strong>Variables:</strong>
                            <ul style="margin: 4px 0; padding-left: 16px; font-size: 12px;">
                                ${Object.entries(term.variables).map(([key, desc]) => 
                                    `<li><code>${key}</code>: ${desc}</li>`
                                ).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${term.safetyNotes ? `
                        <div style="background: #fef3c7; border-left: 3px solid #f59e0b; padding: 8px; margin: 8px 0; font-size: 12px;">
                            <strong>⚠️ Safety:</strong> ${term.safetyNotes}
                        </div>
                    ` : ''}
                    <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
                        Click for detailed explanation with calculations
                    </div>
                `;
            },
            
            getParameterAdvice: function(name, value, recommended, status) {
                const ratio = value / recommended;
                
                switch(status) {
                    case 'danger':
                        if (ratio > 1.5) return `⚠️ Very aggressive setting (${ratio.toFixed(1)}× recommended). High risk of tool failure or poor surface finish.`;
                        if (ratio < 0.3) return `⚠️ Very conservative setting (${ratio.toFixed(1)}× recommended). May cause tool rubbing or work hardening.`;
                        break;
                    case 'warning':
                        if (ratio > 1.2) return `⚡ Aggressive setting (${ratio.toFixed(1)}× recommended). Monitor carefully for tool wear.`;
                        if (ratio < 0.5) return `⚡ Conservative setting (${ratio.toFixed(1)}× recommended). Consider increasing for better efficiency.`;
                        break;
                    case 'good':
                        return `✅ Good setting within safe parameters (${ratio.toFixed(1)}× recommended).`;
                    default:
                        return `📊 Current: ${ratio.toFixed(1)}× recommended value`;
                }
                return '';
            },
            
            positionTooltip: function(tooltip, event) {
                const rect = tooltip.getBoundingClientRect();
                const x = event.clientX + 10;
                const y = event.clientY - rect.height - 10;
                
                tooltip.style.left = Math.min(x, window.innerWidth - rect.width - 10) + 'px';
                tooltip.style.top = Math.max(y, 10) + 'px';
            }
        };

        // ============= DETAILED MODAL SYSTEM =============
        
        const DetailedModal = {
            create: function(title, content) {
                const modal = document.createElement('div');
                modal.className = 'detailed-modal-overlay';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.6);
                    z-index: 2000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    max-width: 90vw;
                    max-height: 90vh;
                    overflow-y: auto;
                    position: relative;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.15);
                `;
                
                modalContent.innerHTML = `
                    <div style="padding: 24px; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; background: white; z-index: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="font-size: 24px; font-weight: bold; margin: 0;">${title}</h2>
                            <button class="close-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 8px; border-radius: 6px; color: #6b7280;">×</button>
                        </div>
                    </div>
                    <div style="padding: 24px;">
                        ${content}
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Close handlers
                modal.querySelector('.close-modal').addEventListener('click', () => {
                    this.close(modal);
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.close(modal);
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.close(modal);
                    }
                });
                
                return modal;
            },
            
            close: function(modal) {
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            },
            
            createCalculationBreakdown: function(result, material, tool, cutType) {
                const materialData = MATERIALS[material];
                const toolData = TOOL_TYPES[tool.type];
                
                return `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div>
                            <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #1f2937;">Input Parameters</h3>
                            <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="margin-bottom: 8px;"><strong>Material:</strong> ${material}</div>
                                <div style="margin-bottom: 8px;"><strong>Tool:</strong> ${toolData.name}</div>
                                <div style="margin-bottom: 8px;"><strong>Cut Type:</strong> ${cutType}</div>
                                <div style="margin-bottom: 8px;"><strong>Diameter:</strong> ${tool.diameter_mm}mm</div>
                                <div style="margin-bottom: 8px;"><strong>Flutes:</strong> ${tool.flutes}</div>
                                <div><strong>Stickout:</strong> ${tool.stickout_mm || 25}mm</div>
                            </div>
                            
                            <h4 style="font-size: 16px; font-weight: bold; margin-bottom: 12px;">Speed Calculation</h4>
                            <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="font-family: monospace; margin-bottom: 8px;">
                                    <strong>RPM = (1000 × Vc) / (π × D)</strong>
                                </div>
                                <div style="font-size: 14px; margin-bottom: 4px;">Where:</div>
                                <ul style="font-size: 14px; margin: 0; padding-left: 20px;">
                                    <li>Vc = ${materialData.vc_range[0]}-${materialData.vc_range[1]} m/min (cutting speed range)</li>
                                    <li>D = ${tool.diameter_mm}mm (tool diameter)</li>
                                    <li>π ≈ 3.14159</li>
                                </ul>
                                <div style="margin-top: 12px; padding: 8px; background: white; border-radius: 4px;">
                                    <strong>Result: ${result.rpm} RPM</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #1f2937;">Feed Calculation</h3>
                            <div style="background: #dbeafe; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="font-family: monospace; margin-bottom: 8px;">
                                    <strong>Feed = RPM × Z × fz</strong>
                                </div>
                                <div style="font-size: 14px; margin-bottom: 4px;">Where:</div>
                                <ul style="font-size: 14px; margin: 0; padding-left: 20px;">
                                    <li>RPM = ${result.rpm} (calculated above)</li>
                                    <li>Z = ${tool.flutes} (number of flutes)</li>
                                    <li>fz = ${result.fz_mm.toFixed(3)}mm (chipload per tooth)</li>
                                </ul>
                                <div style="margin-top: 12px; padding: 8px; background: white; border-radius: 4px;">
                                    <strong>Result: ${result.feed_mm_min} mm/min</strong>
                                </div>
                            </div>
                            
                            <h4 style="font-size: 16px; font-weight: bold; margin-bottom: 12px;">Power Calculation</h4>
                            <div style="background: #fce7f3; padding: 16px; border-radius: 8px;">
                                <div style="font-family: monospace; margin-bottom: 8px;">
                                    <strong>P = SEC × MRR / η</strong>
                                </div>
                                <div style="font-size: 14px; margin-bottom: 4px;">Where:</div>
                                <ul style="font-size: 14px; margin: 0; padding-left: 20px;">
                                    <li>SEC = ${materialData.specific_cutting_energy_J_mm3} J/mm³ (specific cutting energy)</li>
                                    <li>MRR = ${result.mrr_mm3_min} mm³/min (material removal rate)</li>
                                    <li>η ≈ 0.8 (machine efficiency)</li>
                                </ul>
                                <div style="margin-top: 12px; padding: 8px; background: white; border-radius: 4px;">
                                    <strong>Result: ${result.power_W}W</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 24px;">
                        <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #1f2937;">Validation & Safety Analysis</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 16px;">
                                <h4 style="color: #16a34a; margin-bottom: 8px;">✅ Chipload Analysis</h4>
                                <div style="font-size: 14px;">
                                    Target range: ${DetailedModal.getChiploadRange(tool.diameter_mm, materialData)} mm/tooth<br>
                                    Actual: ${result.fz_mm.toFixed(3)} mm/tooth<br>
                                    Status: ${DetailedModal.getChiploadStatus(result.fz_mm, tool.diameter_mm, materialData)}
                                </div>
                            </div>
                            
                            ${result.deflection_mm > 0 ? `
                            <div style="background: ${result.deflection_mm > 0.05 ? '#fef2f2' : result.deflection_mm > 0.02 ? '#fefbeb' : '#f0fdf4'}; border: 1px solid ${result.deflection_mm > 0.05 ? '#fecaca' : result.deflection_mm > 0.02 ? '#fed7aa' : '#bbf7d0'}; border-radius: 8px; padding: 16px;">
                                <h4 style="color: ${result.deflection_mm > 0.05 ? '#dc2626' : result.deflection_mm > 0.02 ? '#d97706' : '#16a34a'}; margin-bottom: 8px;">
                                    ${result.deflection_mm > 0.05 ? '⚠️' : result.deflection_mm > 0.02 ? '⚡' : '✅'} Tool Deflection
                                </h4>
                                <div style="font-size: 14px;">
                                    Calculated: ${result.deflection_mm.toFixed(3)} mm<br>
                                    Acceptable: < 0.02mm (general)<br>
                                    Status: ${result.deflection_mm > 0.05 ? 'Excessive - reduce load' : result.deflection_mm > 0.02 ? 'Moderate - monitor' : 'Good'}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${result.warnings.length > 0 ? `
                    <div style="margin-top: 24px; padding: 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;">
                        <h4 style="color: #dc2626; margin-bottom: 12px;">⚠️ Warnings & Recommendations</h4>
                        ${result.warnings.map(w => `
                            <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid ${w.type === 'danger' ? '#dc2626' : w.type === 'warning' ? '#d97706' : '#2563eb'};">
                                <strong>${w.type.toUpperCase()}:</strong> ${w.message}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                `;
            },
            
            getChiploadRange: function(diameter, material) {
                for (const range of material.fz_mm_per_tooth_by_diameter) {
                    if (diameter <= range.max_d_mm) {
                        return `${range.range[0].toFixed(3)}-${range.range[1].toFixed(3)}`;
                    }
                }
                return 'N/A';
            },
            
            getChiploadStatus: function(actual, diameter, material) {
                for (const range of material.fz_mm_per_tooth_by_diameter) {
                    if (diameter <= range.max_d_mm) {
                        if (actual < range.range[0]) return 'Too low - risk of rubbing';
                        if (actual > range.range[1]) return 'Too high - risk of breakage';
                        return 'Within recommended range';
                    }
                }
                return 'Unknown';
            }
        };

        // ============= CALCULATION ENGINE =============
        
        class SpeedsFeedsCalculator {
            constructor(machine, spindle, tool, material, cutType, aggressiveness = 1.0) {
                this.machine = machine;
                this.spindle = spindle;
                this.tool = tool;
                this.material = material;
                this.cutType = cutType;
                this.aggressiveness = aggressiveness;
                this.warnings = [];
            }

            calculate() {
                this.warnings = [];
                
                // Get effective diameter based on tool type
                const D = this.getEffectiveDiameter();
                const z = this.getEffectiveFlutes();
                
                // Get tool-specific speed factor
                const toolType = TOOL_TYPES[this.tool.type];
                const speedFactor = toolType.speedFactors[this.cutType] || 1.0;
                
                // Get chipload range for tool diameter
                const fzRange = this.getChiploadRange(D);
                const toolFactor = this.material.toolChiploadFactors[this.tool.type] || 1.0;
                
                // Coating factor for chipload - better coatings allow more aggressive cutting
                const coatingFactor = this.getCoatingChiploadFactor();
                
                let fz = (fzRange[0] + fzRange[1]) / 2 * this.aggressiveness * toolFactor * coatingFactor;
                
                // Get engagement parameters
                const { ae, ap } = this.getEngagementParams(D);
                
                // Apply chip thinning if needed
                const aeRatio = ae / D;
                let fzAdjusted = fz;
                if (aeRatio < 0.5 && this.material.chip_thinning.enable_below_fraction) {
                    const phi = 2 * Math.acos(1 - 2 * aeRatio);
                    const chipThinningFactor = Math.PI / phi;
                    fzAdjusted = fz * chipThinningFactor;
                    if (chipThinningFactor > 1.2) {
                        this.warnings.push({ type: 'info', message: 'Chip thinning applied' });
                    }
                }
                
                // Calculate surface speed and RPM
                const vcTarget = (this.material.vc_range[0] + this.material.vc_range[1]) / 2 * speedFactor;
                let rpm = (1000 * vcTarget) / (Math.PI * D);
                
                // Special adjustments for specific tool types
                if (this.tool.type === 'drill') {
                    rpm *= 0.8; // Drilling typically runs slower
                } else if (this.tool.type === 'facemill') {
                    rpm *= 1.2; // Face mills can run faster due to intermittent cutting
                } else if (this.tool.type === 'vbit' || this.tool.type === 'chamfer') {
                    // V-bits and chamfers vary speed based on depth
                    const depthFactor = Math.min(ap / D, 1.0);
                    rpm *= (0.7 + 0.3 * depthFactor);
                }
                
                // Clamp RPM to spindle range
                const originalRpm = rpm;
                rpm = Math.max(this.spindle.rpm_min, Math.min(this.spindle.rpm_max, rpm));
                if (Math.abs(rpm - originalRpm) > originalRpm * 0.1) {
                    this.warnings.push({ 
                        type: 'warning', 
                        message: `RPM clamped to spindle range (wanted ${Math.round(originalRpm)})` 
                    });
                }
                
                // Calculate feed rate
                let vf = rpm * z * fzAdjusted;
                
                // Apply machine feed limits
                const maxFeed = Math.min(
                    this.machine.max_feed_mm_min.x,
                    this.machine.max_feed_mm_min.y,
                    this.machine.max_feed_mm_min.z
                );
                if (vf > maxFeed) {
                    vf = maxFeed;
                    fzAdjusted = vf / (rpm * z);
                    this.warnings.push({ type: 'warning', message: 'Feed limited by machine' });
                }
                
                // Calculate MRR (special case for drilling)
                let mrr;
                if (this.tool.type === 'drill') {
                    mrr = (Math.PI * D * D / 4) * vf; // Circular area × feed
                } else {
                    mrr = ae * ap * vf;
                }
                
                // Calculate power requirement
                const powerRequired = this.calculatePower(ae, ap, vf);
                const powerAvailable = this.getSpindlePowerAtRPM(rpm);
                
                if (powerRequired > powerAvailable * 0.9) {
                    // Reduce feed to stay within power
                    const powerRatio = (powerAvailable * 0.85) / powerRequired;
                    vf *= powerRatio;
                    fzAdjusted *= powerRatio;
                    this.warnings.push({ type: 'warning', message: 'Power limited' });
                }
                
                // Calculate cutting force
                const cuttingForce = this.calculateCuttingForce(ae, ap, fzAdjusted);
                
                // Calculate deflection (not applicable for all tool types)
                let deflection = 0;
                if (['endmill_flat', 'endmill_ball', 'tapered'].includes(this.tool.type)) {
                    deflection = this.calculateDeflection(cuttingForce);
                    if (deflection > 0.05) {
                        this.warnings.push({ type: 'danger', message: `High deflection: ${deflection.toFixed(3)}mm` });
                    } else if (deflection > 0.02) {
                        this.warnings.push({ type: 'warning', message: `Moderate deflection: ${deflection.toFixed(3)}mm` });
                    }
                }
                
                // Calculate dynamic rigidity and chatter analysis
                const rigidityAnalysis = this.calculateDynamicRigidity(rpm, z);
                
                // Apply dynamic rigidity factor to final power requirement
                const finalPowerRequired = powerRequired * (2.0 - rigidityAnalysis.effective_rigidity);
                
                // Check minimum chipload
                const minChipload = fzRange[0] * 0.5;
                if (fzAdjusted < minChipload && !['drill', 'boring'].includes(this.tool.type)) {
                    this.warnings.push({ type: 'danger', message: 'Chipload too low - rubbing risk' });
                }
                
                // Tool-specific warnings
                if (this.tool.type === 'vbit' && ap > D * 0.5) {
                    this.warnings.push({ type: 'warning', message: 'Deep V-carve - consider multiple passes' });
                }
                if (this.tool.type === 'slitting' && vf > 500) {
                    this.warnings.push({ type: 'warning', message: 'High feed for slitting saw - watch for blade flex' });
                }
                if (this.tool.type === 'boring' && cuttingForce > 100) {
                    this.warnings.push({ type: 'warning', message: 'High boring force - check bar rigidity' });
                }
                
                // Calculate actual surface speed
                const vcActual = (Math.PI * D * rpm) / 1000;
                const sfmActual = vcActual * 3.28084;
                
                return {
                    rpm: Math.round(rpm),
                    feed_mm_min: Math.round(vf),
                    fz_mm: fzAdjusted,
                    fz_actual_mm: fz,
                    ae_mm: ae,
                    ap_mm: ap,
                    mrr_mm3_min: Math.round(mrr),
                    power_W: Math.round(finalPowerRequired),
                    power_available_W: Math.round(powerAvailable),
                    force_N: Math.round(cuttingForce),
                    deflection_mm: deflection,
                    vc_m_min: Math.round(vcActual),
                    sfm: Math.round(sfmActual),
                    warnings: this.warnings,
                    toolType: this.tool.type,
                    effectiveDiameter: D,
                    rigidity_analysis: rigidityAnalysis  // Added rigidity analysis
                };
            }
            
            getEffectiveDiameter() {
                switch (this.tool.type) {
                    case 'vbit':
                        // For V-bits, use effective diameter at cutting depth
                        const angle_rad = (this.tool.angle_deg * Math.PI) / 180;
                        const ap_assumed = 2; // Assume 2mm depth for initial calc
                        return this.tool.tip_diameter_mm + 2 * ap_assumed * Math.tan(angle_rad / 2);
                    case 'chamfer':
                        // Use the major diameter
                        return this.tool.diameter_mm;
                    case 'tapered':
                        // Use average of tip and calculated diameter at depth
                        const taper_rad = (this.tool.taper_angle_deg * Math.PI) / 180;
                        const depth = this.tool.flute_length_mm || 10;
                        return this.tool.tip_diameter_mm + depth * Math.tan(taper_rad);
                    case 'boring':
                        // Use minimum bore diameter
                        return this.tool.min_bore_diameter_mm;
                    case 'slitting':
                        // Use saw diameter
                        return this.tool.diameter_mm;
                    case 'facemill':
                        // Use cutter diameter
                        return this.tool.diameter_mm;
                    default:
                        return this.tool.diameter_mm;
                }
            }
            
            getEffectiveFlutes() {
                switch (this.tool.type) {
                    case 'facemill':
                        // For face mills, use insert count
                        return this.tool.insert_count || 4;
                    case 'slitting':
                        // For slitting saws, use tooth count
                        return this.tool.teeth || 40;
                    case 'boring':
                        // Boring bars typically single point
                        return 1;
                    default:
                        return this.tool.flutes || 2;
                }
            }
            
            getChiploadRange(diameter) {
                const ranges = this.material.fz_mm_per_tooth_by_diameter;
                for (let i = 0; i < ranges.length; i++) {
                    if (diameter <= ranges[i].max_d_mm) {
                        return ranges[i].range;
                    }
                }
                return ranges[ranges.length - 1].range;
            }
            
            getEngagementParams(D) {
                const cutDef = CUT_TYPES[this.cutType];
                const matLimits = this.material;
                
                let ae, ap;
                
                // Special handling for different tool types
                if (this.tool.type === 'drill') {
                    ae = D; // Full diameter
                    ap = D * 2; // Depth per revolution
                } else if (this.tool.type === 'vbit') {
                    // V-bit engagement depends on carve depth
                    const aeRange = cutDef.ae_fraction_range || [0.5, 0.8];
                    ae = D * (aeRange[0] + aeRange[1]) / 2;
                    ap = D * 0.3; // Conservative depth
                } else if (this.tool.type === 'slitting') {
                    ae = this.tool.width_mm || D * 0.1;
                    ap = D * 0.5; // Depth of cut into material
                } else {
                    // Standard calculation for end mills and similar
                    if (this.cutType === 'slot') {
                        ae = D;
                    } else {
                        const aeRange = cutDef.ae_fraction_range || [cutDef.ae_fraction, cutDef.ae_fraction];
                        const aeFraction = (aeRange[0] + aeRange[1]) / 2;
                        const maxAe = D * (matLimits.max_radial_engagement_fraction[this.cutType] || 0.3);
                        ae = Math.min(D * aeFraction, maxAe) * this.machine.aggressiveness.radial;
                    }
                    
                    const apRange = cutDef.ap_fraction_range;
                    const apFraction = (apRange[0] + apRange[1]) / 2;
                    const maxAp = D * (matLimits.max_axial_per_pass_D[this.cutType] || 1.0);
                    ap = Math.min(D * apFraction, maxAp) * this.machine.aggressiveness.axial;
                }
                
                return { ae, ap };
            }
            
            calculatePower(ae, ap, vf) {
                // Physics-based power calculation using specific cutting energy
                // Based on: P = (MRR × U_s) / η_tool where MRR=ae×ap×vf, U_s=specific cutting energy
                
                const MRR = ae * ap * vf; // Material Removal Rate in mm³/min
                
                // Get specific cutting energy for material (J/mm³)
                const specificEnergy = this.material.specific_cutting_energy_J_mm3 || 
                                     this.getDefaultSpecificEnergy();
                
                // Base cutting power (convert from mm³/min to mm³/s, then to Watts)
                const basePower = (MRR * specificEnergy) / 60; // Watts
                
                // Tool efficiency factors (replaces previous arbitrary adjustments)
                let toolEfficiency = this.getToolEfficiency();
                
                // Apply tool-specific power factors
                let powerFactor = 1.0;
                if (this.tool.type === 'facemill') {
                    powerFactor = 0.7; // Intermittent engagement reduces average power
                } else if (this.tool.type === 'slitting') {
                    powerFactor = 1.2; // Higher power due to chip evacuation challenges
                } else if (this.tool.type === 'drill') {
                    powerFactor = 1.1; // Additional power for thrust component
                }
                
                // Net cutting power
                const netPower = basePower * powerFactor / toolEfficiency;
                
                // Apply machine rigidity factor (affects power efficiency)
                const rigidityFactor = this.machine.K_rigidity || 1.0;
                
                return netPower * rigidityFactor;
            }
            
            getDefaultSpecificEnergy() {
                // Fallback specific cutting energy values (J/mm³) if not defined in material
                const defaults = {
                    'al_6061_t6': 0.7,
                    'al_7075_t6': 0.8,
                    'brass': 0.5,
                    'steel_mild': 2.8,
                    'steel_1045': 3.2,
                    'ss_304': 4.2,
                    'titanium': 5.5,
                    'acrylic': 0.1,
                    'delrin': 0.15,
                    'mdf': 0.05,
                    'hardwood': 0.08
                };
                return defaults[this.material.id] || 2.0;
            }
            
            getToolEfficiency() {
                // Tool efficiency based on type and coating
                let baseEfficiency = 0.8; // Default efficiency
                
                // Coating adjustments
                if (this.tool.coating === 'tialn') {
                    baseEfficiency = 0.85; // TiAlN provides best efficiency
                } else if (this.tool.coating === 'alcrn') {
                    baseEfficiency = 0.84; // AlCrN similar to TiAlN
                } else if (this.tool.coating === 'ticn') {
                    baseEfficiency = 0.83; // TiCN good performance
                } else if (this.tool.coating === 'tin') {
                    baseEfficiency = 0.82; // TiN standard coating
                } else if (this.tool.coating === 'diamond_like') {
                    baseEfficiency = 0.87; // DLC excellent for non-ferrous
                } else if (this.tool.coating === 'uncoated') {
                    baseEfficiency = 0.75; // Lower efficiency uncoated
                }
                
                // Tool type adjustments
                if (this.tool.type === 'endmill_ball') {
                    baseEfficiency *= 0.9; // Ball end less efficient
                } else if (this.tool.type === 'vbit') {
                    baseEfficiency *= 0.85; // V-bits less efficient
                }
                
                return baseEfficiency;
            }
            
            getCoatingChiploadFactor() {
                // Coating-specific chipload multipliers - better coatings allow more aggressive cutting
                switch (this.tool.coating) {
                    case 'diamond_like':
                        return 1.15; // DLC excellent for non-ferrous materials
                    case 'tialn':
                        return 1.12; // TiAlN good for high-speed machining
                    case 'alcrn':
                        return 1.10; // AlCrN excellent heat resistance
                    case 'ticn':
                        return 1.08; // TiCN good wear resistance
                    case 'tin':
                        return 1.05; // TiN standard coating improvement
                    case 'uncoated':
                    default:
                        return 1.0; // Baseline for uncoated tools
                }
            }
            
            getSpindlePowerAtRPM(rpm) {
                const { rated_power_kW, base_rpm, rpm_min, rpm_max } = this.spindle;
                
                if (rpm < rpm_min || rpm > rpm_max) return 0;
                
                if (rpm <= base_rpm) {
                    // Constant torque region
                    return (rated_power_kW * 1000) * (rpm / base_rpm);
                } else {
                    // Constant power region
                    return rated_power_kW * 1000;
                }
            }
            
            calculateCuttingForce(ae, ap, fz) {
                const K = this.material.force_coeff_KN_mm2;
                const area = ae * fz; // Chip cross-section
                
                // Tool-specific force adjustments
                let forceFactor = 1.0;
                if (this.tool.type === 'drill') {
                    forceFactor = 1.5; // Drilling has higher thrust forces
                } else if (this.tool.type === 'vbit' || this.tool.type === 'chamfer') {
                    forceFactor = 0.7; // Angled cutting reduces forces
                } else if (this.tool.type === 'facemill') {
                    forceFactor = 0.6; // Intermittent cutting
                }
                
                const force = K * area * 1000 * forceFactor; // Convert to N
                return force;
            }
            
            calculateDeflection(force) {
                // Comprehensive deflection model including bending, shear, and holder compliance
                const L = this.tool.stickout_mm || 20;  // Tool stickout length
                const d = this.tool.shank_mm || this.tool.diameter_mm;  // Tool diameter
                
                // Corrected Young's modulus values (MPa) - previously too low for carbide
                let E = 600000; // Carbide Young's modulus (corrected from 200,000)
                if (this.tool.material === 'hss') {
                    E = 210000; // HSS Young's modulus (confirmed correct)
                } else if (this.tool.material === 'cermet') {
                    E = 450000; // Cermet tools
                }
                
                // Calculate individual deflection components
                
                // 1. Bending deflection (cantilever beam theory)
                const I = Math.PI * Math.pow(d, 4) / 64; // Second moment of area (mm⁴)
                const bendingDeflection = (force * Math.pow(L, 3)) / (3 * E * I);
                
                // 2. Shear deflection (significant for short, thick tools)
                const G = E / 2.6; // Shear modulus approximation
                const A = Math.PI * Math.pow(d, 2) / 4; // Cross-sectional area (mm²)
                const k = 1.33; // Shape factor for circular cross-section
                const shearDeflection = (k * force * L) / (G * A);
                
                // 3. Tool holder compliance (critical for machine rigidity)
                const holderCompliance = this.getToolHolderCompliance();
                const holderDeflection = force * holderCompliance;
                
                // 4. Spindle compliance (for complete model)
                const spindleCompliance = this.getSpindleCompliance();
                const spindleDeflection = force * spindleCompliance;
                
                // Total deflection
                const totalDeflection = bendingDeflection + shearDeflection + 
                                      holderDeflection + spindleDeflection;
                
                return totalDeflection;
            }
            
            getToolHolderCompliance() {
                // Tool holder compliance values (mm/N) based on holder type
                // These are critical for machine rigidity calculations
                const holderType = this.tool.holderType || 'collet'; // Default to collet
                
                const compliance = {
                    'shrink_fit': 0.0005,    // Best rigidity
                    'hydraulic': 0.0003,     // Excellent rigidity  
                    'collet': 0.001,         // Good rigidity (most common)
                    'end_mill_holder': 0.002, // Fair rigidity
                    'poor_setup': 0.005      // Poor rigidity warning
                };
                
                return compliance[holderType] || compliance['collet'];
            }
            
            getSpindleCompliance() {
                // Spindle compliance varies by machine type and spindle design
                const machineType = this.machine.rigidity_class || 'hobby';
                
                const spindleCompliance = {
                    'light_hobby': 0.003,    // Typical router spindle
                    'printnc': 0.002,        // Solid design
                    'rigid_hobby': 0.0015,   // Well-built hobby machine
                    'benchtop': 0.001,       // Commercial benchtop
                    'vmc_like': 0.0005       // VMC-style spindle
                };
                
                return spindleCompliance[machineType] || 0.002;
            }
            
            calculateDynamicRigidity(rpm, z) {
                // Calculate dynamic rigidity factor based on cutting frequency vs natural frequency
                // This is critical for avoiding chatter and maintaining accuracy
                
                const flutes = z || this.tool.flutes || 2;
                const cuttingFrequency = (rpm * flutes) / 60; // Hz (tool passing frequency)
                const naturalFreq = this.machine.natural_frequency_hz || 60;
                const dampingRatio = this.machine.damping_ratio || 0.08;
                
                // Frequency ratio
                const freqRatio = cuttingFrequency / naturalFreq;
                
                // Dynamic rigidity factor (corrected implementation)
                let dynamicRigidityFactor;
                if (freqRatio > 2.0) {
                    // High frequency operation - excellent dynamic rigidity
                    dynamicRigidityFactor = 0.95;
                } else {
                    // Calculate from frequency response
                    const denominator = Math.sqrt(
                        Math.pow(1 - freqRatio * freqRatio, 2) + 
                        Math.pow(2 * dampingRatio * freqRatio, 2)
                    );
                    dynamicRigidityFactor = 1 / Math.max(denominator, 1.0);
                }
                
                // Apply dynamic factor to static rigidity
                const effectiveRigidity = this.machine.K_rigidity * dynamicRigidityFactor;
                
                // Add warnings for problematic frequency ranges
                this.addRigidityWarnings(freqRatio, cuttingFrequency, naturalFreq);
                
                return {
                    static_rigidity: this.machine.K_rigidity,
                    dynamic_rigidity_factor: dynamicRigidityFactor,
                    effective_rigidity: effectiveRigidity,
                    cutting_frequency_hz: cuttingFrequency,
                    natural_frequency_hz: naturalFreq,
                    frequency_ratio: freqRatio
                };
            }
            
            addRigidityWarnings(freqRatio, cuttingFreq, naturalFreq) {
                // Add warnings for frequency ranges that could cause problems
                
                if (freqRatio > 0.8 && freqRatio < 1.2) {
                    this.warnings.push({ 
                        type: 'danger', 
                        message: `CHATTER RISK: Cutting frequency (${cuttingFreq.toFixed(1)}Hz) near natural frequency (${naturalFreq}Hz)` 
                    });
                } else if (freqRatio > 0.7 && freqRatio < 1.3) {
                    this.warnings.push({ 
                        type: 'warning', 
                        message: `Caution: Cutting frequency approaching resonance zone` 
                    });
                }
                
                if (freqRatio > 2.0) {
                    this.warnings.push({ 
                        type: 'info', 
                        message: `High frequency operation - excellent dynamic rigidity` 
                    });
                }
                
                if (freqRatio < 0.5) {
                    this.warnings.push({ 
                        type: 'info', 
                        message: `Low frequency operation - static rigidity dominates` 
                    });
                }
            }
        }

        // ============= MAIN COMPONENT =============
        
        function App() {
            // State management
            const [units, setUnits] = useState('metric');
            const [selectedMachine, setSelectedMachine] = useState('printnc');
            const [selectedMaterials, setSelectedMaterials] = useState(['al_6061_t6']);
            const [selectedCutTypes, setSelectedCutTypes] = useState(['profile']);
            const [aggressiveness, setAggressiveness] = useState(1.0);
            const [results, setResults] = useState([]);
            const [isCalculating, setIsCalculating] = useState(false);
            const [showAdvancedTools, setShowAdvancedTools] = useState(false);
            
            // Spindle configuration
            const [spindle, setSpindle] = useState({
                rated_power_kW: 2.2,
                rpm_min: 8000,
                rpm_max: 24000,
                base_rpm: 12000
            });
            
            // Tool configuration
            const [tool, setTool] = useState({
                type: 'endmill_flat',
                diameter_mm: 6,
                flutes: 2,
                material: 'carbide',
                coating: 'tialn',
                stickout_mm: 20,
                shank_mm: 6,
                // Additional parameters for special tools
                angle_deg: 90,
                tip_diameter_mm: 0.1,
                max_diameter_mm: 12,
                insert_count: 4,
                insert_size_mm: 10,
                max_doc_mm: 2,
                point_angle_deg: 118,
                flute_length_mm: 30,
                pitch_mm: 1.5,
                thread_depth_mm: 0.5,
                taper_angle_deg: 5,
                min_bore_diameter_mm: 10,
                bar_diameter_mm: 8,
                max_depth_mm: 50,
                insert_type: 'CCMT',
                width_mm: 3,
                teeth: 40,
                arbor_hole_mm: 22
            });
            
            // Get available cut types based on selected tool
            const getAvailableCutTypes = useCallback(() => {
                const toolType = TOOL_TYPES[tool.type];
                if (!toolType) return [];
                
                return Object.entries(CUT_TYPES)
                    .filter(([key, cut]) => cut.toolTypes.includes(tool.type))
                    .map(([key, cut]) => ({ key, ...cut }));
            }, [tool.type]);
            
            // Update selected cut types when tool changes
            useEffect(() => {
                const availableCuts = getAvailableCutTypes();
                const availableKeys = availableCuts.map(c => c.key);
                
                // Filter out any selected cuts that aren't available for this tool
                const validSelections = selectedCutTypes.filter(ct => availableKeys.includes(ct));
                
                // If no valid selections remain, select the first available
                if (validSelections.length === 0 && availableKeys.length > 0) {
                    setSelectedCutTypes([availableKeys[0]]);
                } else if (validSelections.length !== selectedCutTypes.length) {
                    setSelectedCutTypes(validSelections);
                }
            }, [tool.type, getAvailableCutTypes]);
            
            // Calculate results
            const calculateResults = useCallback(() => {
                setIsCalculating(true);
                const newResults = [];
                
                const machine = MACHINE_PRESETS[selectedMachine];
                
                selectedMaterials.forEach(matId => {
                    const material = MATERIALS[matId];
                    
                    selectedCutTypes.forEach(cutType => {
                        if (!CUT_TYPES[cutType]) return;
                        
                        const calculator = new SpeedsFeedsCalculator(
                            machine,
                            spindle,
                            tool,
                            material,
                            cutType,
                            aggressiveness
                        );
                        
                        const result = calculator.calculate();
                        newResults.push({
                            ...result,
                            material: material.name,
                            materialId: matId,
                            cutType: CUT_TYPES[cutType].name,
                            cutTypeId: cutType
                        });
                    });
                });
                
                setResults(newResults);
                setTimeout(() => setIsCalculating(false), 300);
            }, [selectedMachine, selectedMaterials, selectedCutTypes, spindle, tool, aggressiveness]);
            
            // Auto-calculate on changes
            useEffect(() => {
                if (selectedMaterials.length > 0 && selectedCutTypes.length > 0) {
                    calculateResults();
                }
            }, [calculateResults]);
            
            // Show detailed calculation modal
            const showDetailedCalculation = (result, materialId, tool, cutType) => {
                const modal = DetailedModal.create(
                    `Detailed Calculation: ${result.material} - ${result.cutType}`,
                    DetailedModal.createCalculationBreakdown(result, materialId, tool, result.cutTypeId)
                );
            };
            
            // Initialize tooltip system
            useEffect(() => {
                const initializeTooltips = () => {
                    // Initialize term tooltips
                    document.querySelectorAll('.tooltip-term').forEach(element => {
                        const term = element.getAttribute('data-term');
                        if (term && INDUSTRY_TERMS[term]) {
                            TooltipSystem.createTooltip(element, term, 'formula');
                        }
                    });
                    
                    // Initialize parameter tooltips
                    document.querySelectorAll('.result-value').forEach(element => {
                        const param = element.getAttribute('data-param');
                        const value = parseFloat(element.getAttribute('data-value'));
                        const min = parseFloat(element.getAttribute('data-min'));
                        const max = parseFloat(element.getAttribute('data-max'));
                        const recommended = parseFloat(element.getAttribute('data-recommended'));
                        const unit = element.getAttribute('data-unit') || '';
                        
                        if (param && !isNaN(value)) {
                            // Determine status
                            let status = 'good';
                            if (value > recommended * 1.5 || value < recommended * 0.3) {
                                status = 'danger';
                            } else if (value > recommended * 1.2 || value < recommended * 0.5) {
                                status = 'warning';
                            }
                            
                            const paramData = {
                                name: param.charAt(0).toUpperCase() + param.slice(1),
                                value: value,
                                min: min,
                                max: max,
                                recommended: recommended,
                                unit: unit,
                                status: status
                            };
                            
                            TooltipSystem.createTooltip(element, paramData, 'parameter');
                        }
                    });
                };
                
                // Delay initialization to ensure DOM is ready
                const timer = setTimeout(initializeTooltips, 100);
                return () => clearTimeout(timer);
            }, [results]);
            
            // Export/Import functions
            const exportSettings = () => {
                const settings = {
                    machine: selectedMachine,
                    spindle,
                    tool,
                    materials: selectedMaterials,
                    cutTypes: selectedCutTypes,
                    aggressiveness,
                    results
                };
                const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'cnc-speeds-feeds-settings.json';
                a.click();
            };
            
            const importSettings = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const settings = JSON.parse(e.target.result);
                            setSelectedMachine(settings.machine || 'printnc');
                            setSpindle(settings.spindle || spindle);
                            setTool(settings.tool || tool);
                            setSelectedMaterials(settings.materials || ['al_6061_t6']);
                            setSelectedCutTypes(settings.cutTypes || ['profile']);
                            setAggressiveness(settings.aggressiveness || 1.0);
                        } catch (error) {
                            alert('Invalid settings file');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            const copyResultsAsCSV = () => {
                const headers = ['Material', 'Cut Type', 'Tool', 'RPM', 'Feed (mm/min)', 'Chipload (mm)', 'WOC (mm)', 'DOC (mm)', 'MRR (mm³/min)', 'Power (W)', 'Force (N)', 'Deflection (mm)'];
                const rows = results.map(r => [
                    r.material,
                    r.cutType,
                    TOOL_TYPES[r.toolType].name,
                    r.rpm,
                    r.feed_mm_min,
                    r.fz_mm.toFixed(4),
                    r.ae_mm.toFixed(2),
                    r.ap_mm.toFixed(2),
                    r.mrr_mm3_min,
                    r.power_W,
                    r.force_N,
                    r.deflection_mm.toFixed(4)
                ]);
                
                const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
                navigator.clipboard.writeText(csv);
            };
            
            // Render tool-specific parameters
            const renderToolParameters = () => {
                const toolType = TOOL_TYPES[tool.type];
                if (!toolType) return null;
                
                const parameterConfigs = {
                    diameter_mm: { label: 'Diameter (mm)', type: 'number', step: 0.1, min: 0.1 },
                    flutes: { label: 'Flutes', type: 'number', step: 1, min: 1, max: 8 },
                    stickout_mm: { label: 'Stickout (mm)', type: 'number', step: 1, min: 1 },
                    shank_mm: { label: 'Shank (mm)', type: 'number', step: 0.1, min: 0.1 },
                    angle_deg: { label: 'Angle (°)', type: 'number', step: 1, min: 10, max: 180 },
                    tip_diameter_mm: { label: 'Tip Diameter (mm)', type: 'number', step: 0.01, min: 0 },
                    max_diameter_mm: { label: 'Max Diameter (mm)', type: 'number', step: 0.1, min: 0.1 },
                    insert_count: { label: 'Insert Count', type: 'number', step: 1, min: 1, max: 20 },
                    insert_size_mm: { label: 'Insert Size (mm)', type: 'number', step: 0.1, min: 1 },
                    max_doc_mm: { label: 'Max DOC (mm)', type: 'number', step: 0.1, min: 0.1 },
                    point_angle_deg: { label: 'Point Angle (°)', type: 'number', step: 1, min: 90, max: 180 },
                    flute_length_mm: { label: 'Flute Length (mm)', type: 'number', step: 1, min: 1 },
                    pitch_mm: { label: 'Thread Pitch (mm)', type: 'number', step: 0.01, min: 0.1 },
                    thread_depth_mm: { label: 'Thread Depth (mm)', type: 'number', step: 0.01, min: 0.1 },
                    taper_angle_deg: { label: 'Taper Angle (°)', type: 'number', step: 0.1, min: 0.1, max: 45 },
                    min_bore_diameter_mm: { label: 'Min Bore Ø (mm)', type: 'number', step: 0.1, min: 1 },
                    bar_diameter_mm: { label: 'Bar Diameter (mm)', type: 'number', step: 0.1, min: 1 },
                    max_depth_mm: { label: 'Max Depth (mm)', type: 'number', step: 1, min: 1 },
                    insert_type: { label: 'Insert Type', type: 'select', options: ['CCMT', 'DCMT', 'TCMT', 'VCMT'] },
                    width_mm: { label: 'Width (mm)', type: 'number', step: 0.1, min: 0.1 },
                    teeth: { label: 'Teeth', type: 'number', step: 1, min: 10, max: 200 },
                    arbor_hole_mm: { label: 'Arbor Hole (mm)', type: 'number', step: 0.1, min: 1 }
                };
                
                return toolType.parameters.map(param => {
                    const config = parameterConfigs[param];
                    if (!config) return null;
                    
                    if (config.type === 'select') {
                        return (
                            <div key={param}>
                                <label className="text-sm text-gray-600">{config.label}</label>
                                <select
                                    value={tool[param]}
                                    onChange={(e) => setTool({...tool, [param]: e.target.value})}
                                    className="w-full px-2 py-1 border rounded"
                                >
                                    {config.options.map(opt => (
                                        <option key={opt} value={opt}>{opt}</option>
                                    ))}
                                </select>
                            </div>
                        );
                    }
                    
                    return (
                        <div key={param}>
                            <label className="text-sm text-gray-600">{config.label}</label>
                            <input
                                type={config.type}
                                value={tool[param] || ''}
                                onChange={(e) => setTool({...tool, [param]: parseFloat(e.target.value) || 0})}
                                className="w-full px-2 py-1 border rounded"
                                step={config.step}
                                min={config.min}
                                max={config.max}
                            />
                        </div>
                    );
                }).filter(Boolean);
            };
            
            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="px-4 py-3">
                            <div className="flex items-center justify-between">
                                <h1 className="text-2xl font-bold text-gray-900">CNC Speeds & Feeds Calculator</h1>
                                <div className="flex items-center gap-4">
                                    <select 
                                        value={selectedMachine}
                                        onChange={(e) => setSelectedMachine(e.target.value)}
                                        className="px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        {Object.entries(MACHINE_PRESETS).map(([key, preset]) => (
                                            <option key={key} value={key}>{preset.name}</option>
                                        ))}
                                    </select>
                                    <button 
                                        onClick={exportSettings}
                                        className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                                    >
                                        Export
                                    </button>
                                    <label className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors cursor-pointer">
                                        Import
                                        <input type="file" accept=".json" onChange={importSettings} className="hidden" />
                                    </label>
                                </div>
                            </div>
                        </div>
                    </header>
                    
                    <div className="flex h-[calc(100vh-65px)]">
                        {/* Left Panel - Inputs */}
                        <div className="w-80 bg-white border-r overflow-y-auto">
                            <div className="p-4 space-y-4">
                                {/* Spindle Configuration */}
                                <div className="bg-gray-50 rounded-lg p-4">
                                    <h3 className="font-semibold mb-3">Spindle Configuration</h3>
                                    <div className="space-y-2">
                                        <div>
                                            <label className="text-sm text-gray-600">Power (kW)</label>
                                            <input 
                                                type="number"
                                                value={spindle.rated_power_kW}
                                                onChange={(e) => setSpindle({...spindle, rated_power_kW: parseFloat(e.target.value)})}
                                                className="w-full px-2 py-1 border rounded"
                                                step="0.1"
                                            />
                                        </div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div>
                                                <label className="text-sm text-gray-600">Min RPM</label>
                                                <input 
                                                    type="number"
                                                    value={spindle.rpm_min}
                                                    onChange={(e) => setSpindle({...spindle, rpm_min: parseInt(e.target.value)})}
                                                    className="w-full px-2 py-1 border rounded"
                                                />
                                            </div>
                                            <div>
                                                <label className="text-sm text-gray-600">Max RPM</label>
                                                <input 
                                                    type="number"
                                                    value={spindle.rpm_max}
                                                    onChange={(e) => setSpindle({...spindle, rpm_max: parseInt(e.target.value)})}
                                                    className="w-full px-2 py-1 border rounded"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Tool Configuration */}
                                <div className="bg-gray-50 rounded-lg p-4">
                                    <h3 className="font-semibold mb-3">Tool Configuration</h3>
                                    <div className="space-y-2">
                                        <div>
                                            <label className="text-sm text-gray-600">Tool Type</label>
                                            <select 
                                                value={tool.type}
                                                onChange={(e) => setTool({...tool, type: e.target.value})}
                                                className="w-full px-2 py-1 border rounded"
                                            >
                                                <optgroup label="Common">
                                                    <option value="endmill_flat">🔧 Flat End Mill</option>
                                                    <option value="endmill_ball">⚪ Ball End Mill</option>
                                                    <option value="drill">⫸ Drill Bit</option>
                                                </optgroup>
                                                <optgroup label="Specialized">
                                                    <option value="chamfer">⟋ Chamfer Mill</option>
                                                    <option value="vbit">▼ V-Bit / V-Carve</option>
                                                    <option value="facemill">⬡ Face Mill (Insert)</option>
                                                    <option value="threadmill">⟿ Thread Mill</option>
                                                    <option value="tapered">⩙ Tapered End Mill</option>
                                                </optgroup>
                                                <optgroup label="Advanced">
                                                    <option value="boring">○ Boring Bar</option>
                                                    <option value="slitting">⊕ Slitting Saw</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                        
                                        {/* Dynamic tool parameters */}
                                        {renderToolParameters()}
                                        
                                        <div>
                                            <label className="text-sm text-gray-600">Material</label>
                                            <select 
                                                value={tool.material}
                                                onChange={(e) => setTool({...tool, material: e.target.value})}
                                                className="w-full px-2 py-1 border rounded"
                                            >
                                                <option value="carbide">Carbide</option>
                                                <option value="hss">HSS</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label className="text-sm text-gray-600">Coating</label>
                                            <select 
                                                value={tool.coating}
                                                onChange={(e) => setTool({...tool, coating: e.target.value})}
                                                className="w-full px-2 py-1 border rounded"
                                            >
                                                <option value="uncoated">Uncoated</option>
                                                <option value="tin">TiN (Titanium Nitride)</option>
                                                <option value="ticn">TiCN (Titanium Carbonitride)</option>
                                                <option value="tialn">TiAlN (Titanium Aluminum Nitride)</option>
                                                <option value="alcrn">AlCrN (Aluminum Chromium Nitride)</option>
                                                <option value="diamond_like">DLC (Diamond-Like Carbon)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Cut Types */}
                                <div className="bg-gray-50 rounded-lg p-4">
                                    <h3 className="font-semibold mb-3">Cut Types</h3>
                                    <div className="space-y-2">
                                        {getAvailableCutTypes().map(cut => (
                                            <label key={cut.key} className="flex items-center">
                                                <input 
                                                    type="checkbox"
                                                    checked={selectedCutTypes.includes(cut.key)}
                                                    onChange={(e) => {
                                                        if (e.target.checked) {
                                                            setSelectedCutTypes([...selectedCutTypes, cut.key]);
                                                        } else {
                                                            setSelectedCutTypes(selectedCutTypes.filter(t => t !== cut.key));
                                                        }
                                                    }}
                                                    className="mr-2"
                                                />
                                                {cut.name}
                                            </label>
                                        ))}
                                        {getAvailableCutTypes().length === 0 && (
                                            <p className="text-sm text-gray-500">Select a tool type to see available operations</p>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Materials */}
                                <div className="bg-gray-50 rounded-lg p-4">
                                    <h3 className="font-semibold mb-3">Materials</h3>
                                    <div className="space-y-2 max-h-60 overflow-y-auto">
                                        {Object.entries(MATERIALS).map(([key, mat]) => (
                                            <label key={key} className="flex items-center">
                                                <input 
                                                    type="checkbox"
                                                    checked={selectedMaterials.includes(key)}
                                                    onChange={(e) => {
                                                        if (e.target.checked) {
                                                            setSelectedMaterials([...selectedMaterials, key]);
                                                        } else {
                                                            setSelectedMaterials(selectedMaterials.filter(m => m !== key));
                                                        }
                                                    }}
                                                    className="mr-2"
                                                />
                                                {mat.name}
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Aggressiveness */}
                                <div className="bg-gray-50 rounded-lg p-4">
                                    <h3 className="font-semibold mb-3">Aggressiveness: {aggressiveness.toFixed(1)}</h3>
                                    <input 
                                        type="range"
                                        min="0.5"
                                        max="1.5"
                                        step="0.1"
                                        value={aggressiveness}
                                        onChange={(e) => setAggressiveness(parseFloat(e.target.value))}
                                        className="w-full"
                                    />
                                    <div className="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>Conservative</span>
                                        <span>Baseline</span>
                                        <span>Aggressive</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Main Content - Results */}
                        <div className="flex-1 overflow-y-auto p-6">
                            {results.length > 0 ? (
                                <div className="space-y-6">
                                    {/* Summary Cards */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {results.map((result, idx) => (
                                            <div key={idx} className="bg-white rounded-lg shadow-sm border p-4 animate-slideIn">
                                                <div className="flex justify-between items-start mb-2 cursor-pointer result-card-header" 
                                                     onClick={() => showDetailedCalculation(result, matId, tool, cutType)}>
                                                    <div>
                                                        <h4 className="font-semibold">{result.material}</h4>
                                                        <p className="text-sm text-gray-600">
                                                            {result.cutType} • {TOOL_TYPES[result.toolType].icon} {TOOL_TYPES[result.toolType].name}
                                                        </p>
                                                        <p className="text-xs text-blue-600">Click for detailed calculations</p>
                                                    </div>
                                                    <div className="flex gap-1">
                                                        {result.warnings.map((w, i) => (
                                                            <span 
                                                                key={i}
                                                                className={`w-2 h-2 rounded-full ${
                                                                    w.type === 'danger' ? 'bg-red-500' : 
                                                                    w.type === 'warning' ? 'bg-yellow-500' : 
                                                                    'bg-blue-500'
                                                                }`}
                                                                title={w.message}
                                                            />
                                                        ))}
                                                    </div>
                                                </div>
                                                
                                                <div className="grid grid-cols-2 gap-2 text-sm">
                                                    <div>
                                                        <span className="text-gray-500 tooltip-term" data-term="RPM">RPM (n):</span>
                                                        <span className="ml-2 font-medium result-value" data-param="rpm" data-value={result.rpm} data-min="6000" data-max="30000" data-recommended="15000" data-unit=" RPM">{result.rpm}</span>
                                                    </div>
                                                    <div>
                                                        <span className="text-gray-500 tooltip-term" data-term="Feed">Feed (Vf):</span>
                                                        <span className="ml-2 font-medium result-value" data-param="feed" data-value={result.feed_mm_min} data-min="100" data-max="5000" data-recommended="1500" data-unit=" mm/min">{result.feed_mm_min} mm/min</span>
                                                    </div>
                                                    <div>
                                                        <span className="text-gray-500 tooltip-term" data-term="Chipload">Chipload (fz):</span>
                                                        <span className="ml-2 font-medium result-value" data-param="chipload" data-value={result.fz_mm} data-min="0.01" data-max="0.5" data-recommended="0.1" data-unit=" mm">{result.fz_mm.toFixed(3)} mm</span>
                                                    </div>
                                                    <div>
                                                        <span className="text-gray-500 tooltip-term" data-term="MRR">MRR (Q):</span>
                                                        <span className="ml-2 font-medium result-value" data-param="mrr" data-value={result.mrr_mm3_min} data-min="100" data-max="50000" data-recommended="5000" data-unit=" mm³/min">{result.mrr_mm3_min} mm³/min</span>
                                                    </div>
                                                    <div>
                                                        <span className="text-gray-500 tooltip-term" data-term="WOC">WOC (ae):</span>
                                                        <span className="ml-2 font-medium result-value" data-param="woc" data-value={result.ae_mm} data-min="0.1" data-max={tool.diameter_mm} data-recommended={tool.diameter_mm * 0.3} data-unit=" mm">{result.ae_mm.toFixed(1)} mm</span>
                                                    </div>
                                                    <div>
                                                        <span className="text-gray-500 tooltip-term" data-term="DOC">DOC (ap):</span>
                                                        <span className="ml-2 font-medium result-value" data-param="doc" data-value={result.ap_mm} data-min="0.1" data-max={tool.diameter_mm * 2} data-recommended={tool.diameter_mm * 0.5} data-unit=" mm">{result.ap_mm.toFixed(1)} mm</span>
                                                    </div>
                                                </div>
                                                
                                                <div className="mt-3 pt-3 border-t">
                                                    <div className="flex justify-between text-sm">
                                                        <div>
                                                            <span className="text-gray-500 tooltip-term" data-term="Power">Power (P):</span>
                                                            <span className={`ml-2 font-medium result-value ${
                                                                result.power_W > result.power_available_W * 0.9 ? 'text-red-600' : ''
                                                            }`} data-param="power" data-value={result.power_W} data-min="100" data-max={result.power_available_W} data-recommended={result.power_available_W * 0.8} data-unit="W">
                                                                {result.power_W}W / {result.power_available_W}W
                                                            </span>
                                                        </div>
                                                        {result.deflection_mm > 0 && (
                                                            <div>
                                                                <span className="text-gray-500 tooltip-term" data-term="Deflection">Deflection (δ):</span>
                                                                <span className={`ml-2 font-medium result-value ${
                                                                    result.deflection_mm > 0.05 ? 'text-red-600' : 
                                                                    result.deflection_mm > 0.02 ? 'text-yellow-600' : ''
                                                                }`} data-param="deflection" data-value={result.deflection_mm} data-min="0" data-max="0.1" data-recommended="0.02" data-unit=" mm">
                                                                    {result.deflection_mm.toFixed(3)} mm
                                                                </span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                
                                                {result.warnings.length > 0 && (
                                                    <div className="mt-3 pt-3 border-t">
                                                        {result.warnings.map((w, i) => (
                                                            <div key={i} className={`text-xs ${
                                                                w.type === 'danger' ? 'text-red-600' : 
                                                                w.type === 'warning' ? 'text-yellow-600' : 
                                                                'text-blue-600'
                                                            }`}>
                                                                • {w.message}
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                    
                                    {/* Detailed Table */}
                                    <div className="bg-white rounded-lg shadow-sm border">
                                        <div className="p-4 border-b flex justify-between items-center">
                                            <h3 className="font-semibold">Detailed Results</h3>
                                            <button 
                                                onClick={copyResultsAsCSV}
                                                className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
                                            >
                                                Copy as CSV
                                            </button>
                                        </div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        <th className="px-4 py-2 text-left">Material</th>
                                                        <th className="px-4 py-2 text-left">Cut Type</th>
                                                        <th className="px-4 py-2 text-left">Tool</th>
                                                        <th className="px-4 py-2 text-right">RPM</th>
                                                        <th className="px-4 py-2 text-right">Feed</th>
                                                        <th className="px-4 py-2 text-right">Chipload</th>
                                                        <th className="px-4 py-2 text-right">WOC</th>
                                                        <th className="px-4 py-2 text-right">DOC</th>
                                                        <th className="px-4 py-2 text-right">MRR</th>
                                                        <th className="px-4 py-2 text-right">Power</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {results.map((result, idx) => (
                                                        <tr key={idx} className="border-b hover:bg-gray-50">
                                                            <td className="px-4 py-2">{result.material}</td>
                                                            <td className="px-4 py-2">{result.cutType}</td>
                                                            <td className="px-4 py-2">
                                                                <span className="tool-icon">{TOOL_TYPES[result.toolType].icon}</span>
                                                                {TOOL_TYPES[result.toolType].name}
                                                            </td>
                                                            <td className="px-4 py-2 text-right">{result.rpm}</td>
                                                            <td className="px-4 py-2 text-right">{result.feed_mm_min}</td>
                                                            <td className="px-4 py-2 text-right">{result.fz_mm.toFixed(4)}</td>
                                                            <td className="px-4 py-2 text-right">{result.ae_mm.toFixed(2)}</td>
                                                            <td className="px-4 py-2 text-right">{result.ap_mm.toFixed(2)}</td>
                                                            <td className="px-4 py-2 text-right">{result.mrr_mm3_min}</td>
                                                            <td className="px-4 py-2 text-right">{result.power_W}W</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex items-center justify-center h-full">
                                    <div className="text-center">
                                        <p className="text-gray-500 mb-2">Select materials and cut types to see results</p>
                                        <p className="text-sm text-gray-400">Configure your machine, spindle, and tool in the left panel</p>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        
        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
