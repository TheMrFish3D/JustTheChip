<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JustTheChip - CNC Speeds & Feeds Calculator</title>
    <meta name="description" content="Professional CNC speeds and feeds calculator with enhanced machine configuration, DOC override, tooltips, and validated formulas">
    
    <!-- No external dependencies - all functionality self-contained -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f8fafc;
            color: #374151;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border-radius: 12px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header-text {
            text-align: left;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .header-controls select {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 5px 10px;
        }
        
        .header-controls select option {
            background: #1d4ed8;
            color: white;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .header-text {
                text-align: center;
            }
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 30px;
        }
        
        /* Layout variations */
        .grid.tabbed {
            grid-template-columns: 1fr;
            gap: 0;
        }
        
        .grid.topbar {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .grid.dashboard {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .grid.accordion {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        /* Tab styles for tabbed layout */
        .tab-container {
            background: var(--theme-bg-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px var(--theme-shadow);
            overflow: hidden;
        }
        
        .tab-nav {
            display: flex;
            background: var(--theme-bg-tertiary);
            border-bottom: 1px solid var(--theme-border);
        }
        
        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s;
        }
        
        .tab-button.active {
            background: var(--theme-bg-secondary);
            color: var(--theme-accent-primary);
            border-bottom: 2px solid var(--theme-accent-primary);
        }
        
        .tab-content {
            padding: 25px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        /* Top bar layout styles */
        .topbar-controls {
            background: var(--theme-bg-secondary);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px var(--theme-shadow);
            margin-bottom: 20px;
        }
        
        .topbar-controls .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        /* Accordion styles */
        .accordion-section {
            background: var(--theme-bg-secondary);
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px var(--theme-shadow);
            overflow: hidden;
        }
        
        .accordion-header {
            background: var(--theme-bg-tertiary);
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .accordion-header:hover {
            background: #f1f5f9;
        }
        
        .accordion-content {
            padding: 20px;
            display: none;
        }
        
        .accordion-content.active {
            display: block;
        }
        
        .accordion-arrow {
            transition: transform 0.2s;
        }
        
        .accordion-header.active .accordion-arrow {
            transform: rotate(180deg);
        }
        
        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        .input-section {
            background: var(--theme-bg-secondary);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px var(--theme-shadow);
            height: fit-content;
        }
        
        .results-section {
            background: var(--theme-bg-secondary);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px var(--theme-shadow);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            background-color: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
            border: 2px solid var(--theme-border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--theme-accent-primary);
            box-shadow: 0 0 0 3px var(--theme-shadow);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        h2 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        h3 {
            color: #374151;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .machine-config {
            background-color: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .machine-config h3 {
            color: #0ea5e9;
            margin-bottom: 10px;
        }
        
        .doc-override {
            background-color: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .doc-override h3 {
            color: #0ea5e9;
            margin-bottom: 10px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: var(--theme-text-inverse);
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--theme-accent-primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .checkbox-item:hover {
            background-color: #f3f4f6;
        }
        
        .checkbox-item input {
            margin-right: 10px;
            width: auto;
        }
        
        .aggressiveness-control {
            margin: 20px 0;
        }
        
        .slider-container {
            margin: 10px 0;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, #10b981, #f59e0b, #ef4444);
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            transition: background-color 0.2s;
        }
        
        .button:hover {
            background: #2563eb;
        }
        
        .button.secondary {
            background: #6b7280;
        }
        
        .button.secondary:hover {
            background: #4b5563;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .results-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        
        .results-table tr:hover {
            background-color: #f9fafb;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-good { background-color: #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-danger { background-color: #ef4444; }
        
        /* Tooltip Styles */
        .tooltip-term {
            cursor: help;
            border-bottom: 1px dotted #6b7280;
            text-decoration: none;
        }
        
        .tooltip-term:hover {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        
        .result-value {
            cursor: help;
            position: relative;
        }
        
        .result-value:hover {
            background-color: #f3f4f6;
            border-radius: 2px;
            padding: 1px 2px;
        }
        
        .tooltip-container {
            position: absolute;
            background: var(--theme-bg-secondary);
            border: 1px solid var(--theme-border);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 10px 25px var(--theme-shadow);
            max-width: 350px;
            z-index: 1000;
            font-size: 14px;
            line-height: 1.4;
            display: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--theme-text-primary);
        }
        
        .tooltip-header {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .parameter-range {
            user-select: none;
        }
        
        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                font-size: 12px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }

        /* Theme System */
        :root {
            --theme-bg-primary: #f8fafc;
            --theme-bg-secondary: #ffffff;
            --theme-bg-tertiary: #f1f5f9;
            --theme-text-primary: #374151;
            --theme-text-secondary: #6b7280;
            --theme-text-inverse: #ffffff;
            --theme-accent-primary: #3b82f6;
            --theme-accent-secondary: #1d4ed8;
            --theme-border: #e5e7eb;
            --theme-shadow: rgba(0, 0, 0, 0.1);
            --theme-warning: #f59e0b;
            --theme-danger: #ef4444;
            --theme-success: #10b981;
        }

        /* Dark Pro Theme */
        body.theme-dark {
            --theme-bg-primary: #0f172a;
            --theme-bg-secondary: #1e293b;
            --theme-bg-tertiary: #334155;
            --theme-text-primary: #f1f5f9;
            --theme-text-secondary: #cbd5e1;
            --theme-text-inverse: #0f172a;
            --theme-accent-primary: #60a5fa;
            --theme-accent-secondary: #3b82f6;
            --theme-border: #475569;
            --theme-shadow: rgba(0, 0, 0, 0.5);
            --theme-warning: #fbbf24;
            --theme-danger: #f87171;
            --theme-success: #34d399;
        }

        /* Clean Light Theme */
        body.theme-light {
            --theme-bg-primary: #ffffff;
            --theme-bg-secondary: #f9fafb;
            --theme-bg-tertiary: #f3f4f6;
            --theme-text-primary: #111827;
            --theme-text-secondary: #6b7280;
            --theme-text-inverse: #ffffff;
            --theme-accent-primary: #4f46e5;
            --theme-accent-secondary: #3730a3;
            --theme-border: #d1d5db;
            --theme-shadow: rgba(0, 0, 0, 0.05);
            --theme-warning: #d97706;
            --theme-danger: #dc2626;
            --theme-success: #059669;
        }

        /* Ocean Breeze Theme */
        body.theme-ocean {
            --theme-bg-primary: #ecfeff;
            --theme-bg-secondary: #cffafe;
            --theme-bg-tertiary: #a5f3fc;
            --theme-text-primary: #164e63;
            --theme-text-secondary: #0891b2;
            --theme-text-inverse: #ffffff;
            --theme-accent-primary: #0891b2;
            --theme-accent-secondary: #0e7490;
            --theme-border: #67e8f9;
            --theme-shadow: rgba(14, 116, 144, 0.2);
            --theme-warning: #ea580c;
            --theme-danger: #dc2626;
            --theme-success: #059669;
        }

        /* Forest Green Theme */
        body.theme-forest {
            --theme-bg-primary: #f0fdf4;
            --theme-bg-secondary: #dcfce7;
            --theme-bg-tertiary: #bbf7d0;
            --theme-text-primary: #14532d;
            --theme-text-secondary: #166534;
            --theme-text-inverse: #ffffff;
            --theme-accent-primary: #16a34a;
            --theme-accent-secondary: #15803d;
            --theme-border: #86efac;
            --theme-shadow: rgba(21, 128, 61, 0.2);
            --theme-warning: #ca8a04;
            --theme-danger: #dc2626;
            --theme-success: #16a34a;
        }

        /* Sunset Orange Theme */
        body.theme-sunset {
            --theme-bg-primary: #fff7ed;
            --theme-bg-secondary: #ffedd5;
            --theme-bg-tertiary: #fed7aa;
            --theme-text-primary: #7c2d12;
            --theme-text-secondary: #9a3412;
            --theme-text-inverse: #ffffff;
            --theme-accent-primary: #ea580c;
            --theme-accent-secondary: #dc2626;
            --theme-border: #fdba74;
            --theme-shadow: rgba(234, 88, 12, 0.2);
            --theme-warning: #d97706;
            --theme-danger: #dc2626;
            --theme-success: #16a34a;
        }

        /* Purple Haze Theme */
        body.theme-purple {
            --theme-bg-primary: #faf5ff;
            --theme-bg-secondary: #f3e8ff;
            --theme-bg-tertiary: #e9d5ff;
            --theme-text-primary: #581c87;
            --theme-text-secondary: #7c3aed;
            --theme-text-inverse: #ffffff;
            --theme-accent-primary: #8b5cf6;
            --theme-accent-secondary: #7c3aed;
            --theme-border: #c4b5fd;
            --theme-shadow: rgba(139, 92, 246, 0.2);
            --theme-warning: #d97706;
            --theme-danger: #dc2626;
            --theme-success: #16a34a;
        }

        /* Minimal Gray Theme */
        body.theme-minimal {
            --theme-bg-primary: #fafafa;
            --theme-bg-secondary: #f5f5f5;
            --theme-bg-tertiary: #e5e5e5;
            --theme-text-primary: #262626;
            --theme-text-secondary: #525252;
            --theme-text-inverse: #ffffff;
            --theme-accent-primary: #404040;
            --theme-accent-secondary: #262626;
            --theme-border: #d4d4d4;
            --theme-shadow: rgba(0, 0, 0, 0.08);
            --theme-warning: #f59e0b;
            --theme-danger: #ef4444;
            --theme-success: #10b981;
        }

        /* Cyberpunk Theme */
        body.theme-cyberpunk {
            --theme-bg-primary: #0a0a0a;
            --theme-bg-secondary: #1a1a1a;
            --theme-bg-tertiary: #2a2a2a;
            --theme-text-primary: #00ff41;
            --theme-text-secondary: #00cc33;
            --theme-text-inverse: #0a0a0a;
            --theme-accent-primary: #ff006e;
            --theme-accent-secondary: #cc0055;
            --theme-border: #333333;
            --theme-shadow: rgba(255, 0, 110, 0.3);
            --theme-warning: #ffaa00;
            --theme-danger: #ff3366;
            --theme-success: #00ff41;
        }

        /* Industrial Theme */
        body.theme-industrial {
            --theme-bg-primary: #27272a;
            --theme-bg-secondary: #3f3f46;
            --theme-bg-tertiary: #52525b;
            --theme-text-primary: #fafafa;
            --theme-text-secondary: #d4d4d8;
            --theme-text-inverse: #27272a;
            --theme-accent-primary: #fbbf24;
            --theme-accent-secondary: #f59e0b;
            --theme-border: #71717a;
            --theme-shadow: rgba(251, 191, 36, 0.2);
            --theme-warning: #fbbf24;
            --theme-danger: #ef4444;
            --theme-success: #22c55e;
        }

        /* Claude Theme - Based on ChatGPT Color Analysis */
        body.theme-claude {
            --theme-bg-primary: #1a1a1a;        /* Main dark background */
            --theme-bg-secondary: #212121;      /* Card/panel backgrounds */
            --theme-bg-tertiary: #2d2d2d;       /* Hover states */
            --theme-text-primary: #ffffff;      /* High contrast white text */
            --theme-text-secondary: #b3b3b3;    /* Muted text */
            --theme-text-inverse: #1a1a1a;      /* Text on light backgrounds */
            --theme-accent-primary: #ff6b35;    /* Claude orange accent */
            --theme-accent-secondary: #e55a2b;  /* Darker orange for hover */
            --theme-border: #3a3a3a;            /* Subtle borders */
            --theme-shadow: rgba(255, 107, 53, 0.15);  /* Orange shadow */
            --theme-warning: #ff6b35;
            --theme-danger: #ff4757;
            --theme-success: #00d084;
        }

        /* Apply theme variables to existing styles */
        body {
            background-color: var(--theme-bg-primary);
            color: var(--theme-text-primary);
        }

        .card {
            background-color: var(--theme-bg-secondary);
            border: 1px solid var(--theme-border);
            box-shadow: 0 4px 6px var(--theme-shadow);
        }

        .form-control {
            background-color: var(--theme-bg-secondary);
            border: 1px solid var(--theme-border);
            color: var(--theme-text-primary);
        }

        .form-control:focus {
            border-color: var(--theme-accent-primary);
            box-shadow: 0 0 0 3px var(--theme-shadow);
        }

        .btn-primary {
            background-color: var(--theme-accent-primary);
            border-color: var(--theme-accent-primary);
            color: var(--theme-text-inverse);
        }

        .btn-primary:hover {
            background-color: var(--theme-accent-secondary);
            border-color: var(--theme-accent-secondary);
        }

        .alert-warning {
            background-color: rgba(251, 191, 36, 0.1);
            border-color: var(--theme-warning);
            color: var(--theme-warning);
        }

        .alert-danger {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: var(--theme-danger);
            color: var(--theme-danger);
        }

        .badge-warning {
            background-color: var(--theme-warning);
            color: var(--theme-text-inverse);
        }

        .badge-danger {
            background-color: var(--theme-danger);
            color: var(--theme-text-inverse);
        }

        /* Header theme updates */
        .header {
            background: linear-gradient(135deg, var(--theme-accent-primary), var(--theme-accent-secondary));
        }

        .header-controls select {
            background: var(--theme-bg-secondary);
            color: var(--theme-text-primary);
            border: 1px solid var(--theme-border);
        }

        .header-controls select option {
            background: var(--theme-bg-secondary);
            color: var(--theme-text-primary);
        }

        /* Special effects for cyberpunk theme */
        body.theme-cyberpunk .header {
            background: linear-gradient(135deg, #ff006e, #8338ec);
            box-shadow: 0 0 20px rgba(255, 0, 110, 0.4);
        }

        body.theme-cyberpunk .card {
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.2);
            border: 1px solid #00ff41;
        }

        body.theme-cyberpunk .form-control {
            background-color: #1a1a1a;
            border: 1px solid #00ff41;
            color: #00ff41;
        }

        body.theme-cyberpunk .form-control:focus {
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        /* Settings Panel Styles */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .settings-panel {
            background: var(--theme-bg-secondary);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px var(--theme-shadow);
            border: 1px solid var(--theme-border);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--theme-border);
        }

        .settings-header h2 {
            color: var(--theme-text-primary);
            margin: 0;
            font-size: 1.5rem;
        }

        .close-settings {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--theme-text-secondary);
            padding: 5px;
            border-radius: 4px;
        }

        .close-settings:hover {
            background: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            color: var(--theme-text-primary);
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        .font-preview {
            background: var(--theme-bg-tertiary);
            border: 1px solid var(--theme-border);
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            color: var(--theme-text-primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1>JustTheChip</h1>
                    <p>Professional CNC Speeds & Feeds Calculator</p>
                    <p>Enhanced with DOC Override, Interactive Tooltips & Validated Formulas</p>
                </div>
                <div class="header-controls">
                    <button id="settingsButton" onclick="toggleSettings()" style="background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 6px; padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        ⚙️ Settings
                    </button>
                    <a href="docs/help.html" style="color: rgba(255, 255, 255, 0.9); text-decoration: none; margin-left: 15px;">📚 Help</a>
                    <a href="src/index.html" style="color: rgba(255, 255, 255, 0.9); text-decoration: none; margin-left: 15px;">🔧 Modular Version</a>
                </div>
            </div>
        </div>
        
        <div class="grid">
            <!-- Input Section -->
            <div class="input-section">
                <h2>🔧 Configuration</h2>
                
                <!-- Enhanced Machine Configuration -->
                <div class="machine-config">
                    <h3>🏭 Enhanced Machine Configuration</h3>
                    <div class="form-group">
                        <label for="machineType">Machine Type:</label>
                        <select id="machineType" onchange="updateMachineConfig()">
                            <option value="light_hobby">Light Hobby Machine</option>
                            <option value="heavy_hobby" selected>PrintNC / Heavy Hobby</option>
                            <option value="light_industrial">Light Industrial</option>
                            <option value="industrial">Industrial Machine</option>
                            <option value="custom">Custom Configuration</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="motorType">Motor Type:</label>
                            <select id="motorType" onchange="updateCalculations()">
                                <option value="stepper" selected>NEMA 23/34 Stepper</option>
                                <option value="ac_servo">AC Servo Motor</option>
                                <option value="dc_servo">DC Servo Motor</option>
                                <option value="brushless">Brushless DC Motor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="driveSystem">Drive System:</label>
                            <select id="driveSystem" onchange="updateCalculations()">
                                <option value="ball_screw" selected>Ball Screw (C5/C7)</option>
                                <option value="lead_screw">Lead Screw (Acme)</option>
                                <option value="belt_drive">Belt Drive (GT2)</option>
                                <option value="rack_pinion">Rack & Pinion</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="motorTorque">Motor Torque (Nm):</label>
                            <input type="number" id="motorTorque" step="0.1" min="0.1" value="3.0" onchange="updateCalculations()">
                        </div>
                        <div class="form-group">
                            <label for="maxMotorRPM">Max Motor RPM:</label>
                            <input type="number" id="maxMotorRPM" step="100" min="100" value="3000" onchange="updateCalculations()">
                        </div>
                    </div>
                </div>
                
                <!-- Spindle Configuration -->
                <div class="form-group">
                    <label for="spindleType">Spindle Type:</label>
                    <select id="spindleType" onchange="updateSpindleConfig()">
                        <option value="dewalt_dwp611">DeWalt DWP611 Router</option>
                        <option value="makita_rt0701c">Makita RT0701C Router</option>
                        <option value="800w_vfd">800W VFD Spindle</option>
                        <option value="2200w_vfd" selected>2.2kW VFD Spindle</option>
                        <option value="4000w_industrial">4kW Industrial Spindle</option>
                        <option value="custom_spindle">Custom Spindle</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="spindlePower">Spindle Power (W):</label>
                    <input type="number" id="spindlePower" step="50" min="50" value="2200" onchange="updateCalculations()">
                </div>
                
                <!-- Tool Configuration -->
                <h3>⚙️ Tool Configuration</h3>
                <div class="form-group">
                    <label for="toolType">Tool Type:</label>
                    <select id="toolType" onchange="updateToolDefaults()">
                        <option value="flat_endmill" selected>Flat End Mill</option>
                        <option value="ball_endmill">Ball End Mill</option>
                        <option value="chamfer_mill">Chamfer Mill</option>
                        <option value="vbit">V-Bit / V-Carve</option>
                        <option value="drill">Drill Bit</option>
                        <option value="facemill">Face Mill (Insert)</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="toolDiameter">Tool Diameter (mm):</label>
                        <input type="number" id="toolDiameter" step="0.1" min="0.1" value="6.0" onchange="updateCalculations()">
                    </div>
                    <div class="form-group">
                        <label for="toolFlutes">Number of Flutes:</label>
                        <input type="number" id="toolFlutes" step="1" min="1" max="8" value="2" onchange="updateCalculations()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="toolStickout">Tool Stickout (mm):</label>
                    <input type="number" id="toolStickout" step="1" min="5" value="25" onchange="updateCalculations()">
                </div>
                
                <!-- Enhanced DOC Override -->
                <div class="doc-override">
                    <h3>🎯 Depth of Cut (DOC) Override</h3>
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableDOCOverride" onchange="toggleDOCOverride()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span style="margin-left: 15px;">Enable Manual DOC Control</span>
                    </div>
                    
                    <div id="docOverrideControls" style="display: none;">
                        <div class="form-group">
                            <label for="customDOC">Custom DOC (mm):</label>
                            <input type="number" id="customDOC" step="0.1" min="0.1" value="1.0" onchange="updateCalculations()">
                        </div>
                        <div id="docWarnings"></div>
                    </div>
                    
                    <div id="docRecommendations">
                        <small>Automatic DOC calculation based on tool and material properties</small>
                    </div>
                </div>
                
                <!-- Material Selection -->
                <div class="form-group">
                    <label>Materials to Calculate:</label>
                    <div class="checkbox-grid">
                        <div class="checkbox-item" onclick="toggleMaterial('aluminum_6061')">
                            <input type="checkbox" id="material_aluminum_6061" checked>
                            <span>Aluminum 6061-T6</span>
                        </div>
                        <div class="checkbox-item" onclick="toggleMaterial('steel_1018')">
                            <input type="checkbox" id="material_steel_1018">
                            <span>Steel 1018 (Mild)</span>
                        </div>
                        <div class="checkbox-item" onclick="toggleMaterial('steel_4140')">
                            <input type="checkbox" id="material_steel_4140">
                            <span>Steel 4140 (Heat Treated)</span>
                        </div>
                        <div class="checkbox-item" onclick="toggleMaterial('stainless_316')">
                            <input type="checkbox" id="material_stainless_316">
                            <span>Stainless Steel 316</span>
                        </div>
                        <div class="checkbox-item" onclick="toggleMaterial('titanium')">
                            <input type="checkbox" id="material_titanium">
                            <span>Titanium Ti-6Al-4V</span>
                        </div>
                        <div class="checkbox-item" onclick="toggleMaterial('delrin')">
                            <input type="checkbox" id="material_delrin">
                            <span>Delrin (POM)</span>
                        </div>
                        <div class="checkbox-item" onclick="toggleMaterial('hardwood')">
                            <input type="checkbox" id="material_hardwood">
                            <span>Hardwood (Oak/Maple)</span>
                        </div>
                    </div>
                </div>
                
                <!-- Cut Types -->
                <div class="form-group">
                    <label>Cut Types:</label>
                    <div class="checkbox-grid">
                        <div class="checkbox-item" onclick="toggleCutType('slotting')">
                            <input type="checkbox" id="cut_slotting">
                            <span>Slotting</span>
                        </div>
                        <div class="checkbox-item" onclick="toggleCutType('profile')">
                            <input type="checkbox" id="cut_profile" checked>
                            <span>Profile/Contour</span>
                        </div>
                        <div class="checkbox-item" onclick="toggleCutType('adaptive')">
                            <input type="checkbox" id="cut_adaptive">
                            <span>Adaptive Clearing</span>
                        </div>
                        <div class="checkbox-item" onclick="toggleCutType('facing')">
                            <input type="checkbox" id="cut_facing">
                            <span>Face Milling</span>
                        </div>
                        <div class="checkbox-item" onclick="toggleCutType('roughing')">
                            <input type="checkbox" id="cut_roughing">
                            <span>Roughing</span>
                        </div>
                        <div class="checkbox-item" onclick="toggleCutType('finishing')">
                            <input type="checkbox" id="cut_finishing">
                            <span>Finishing</span>
                        </div>
                    </div>
                </div>
                
                <!-- Aggressiveness Control -->
                <div class="aggressiveness-control">
                    <label>
                        Aggressiveness Factor: <span id="aggressivenessValue">1.0</span>
                    </label>
                    <div class="slider-container">
                        <input type="range" id="aggressivenessSlider" class="slider" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateAggressiveness(this.value)">
                        <div class="slider-labels">
                            <span>Conservative</span>
                            <span>Moderate</span>
                            <span>Aggressive</span>
                        </div>
                    </div>
                </div>
                
                <!-- Import/Export Controls -->
                <div class="no-print" style="margin-top: 20px;">
                    <button class="button" onclick="exportSettings()">Export Settings</button>
                    <button class="button secondary" onclick="document.getElementById('importInput').click()">Import Settings</button>
                    <input type="file" id="importInput" accept=".json" style="display: none;" onchange="importSettings(event)">
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="results-section">
                <h2>📊 Calculation Results</h2>
                <div id="resultsContainer">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Cut Type</th>
                                <th>RPM</th>
                                <th>Feed (mm/min)</th>
                                <th>Chipload (mm)</th>
                                <th>DOC (mm)</th>
                                <th>Power (W)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- Results will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="settingsOverlay" class="settings-overlay" onclick="closeSettingsOnOverlay(event)">
        <div class="settings-panel">
            <div class="settings-header">
                <h2>⚙️ Settings</h2>
                <button class="close-settings" onclick="toggleSettings()">✕</button>
            </div>
            
            <div class="settings-section">
                <h3>🎨 Appearance</h3>
                <div class="settings-grid">
                    <div class="form-group">
                        <label for="themeSelector">Theme:</label>
                        <select id="themeSelector" onchange="changeTheme()" class="form-control">
                            <option value="default">🔵 Classic Blue</option>
                            <option value="dark">🌙 Dark Pro</option>
                            <option value="light">☀️ Clean Light</option>
                            <option value="ocean">🌊 Ocean Breeze</option>
                            <option value="forest">🌲 Forest Green</option>
                            <option value="sunset">🌅 Sunset Orange</option>
                            <option value="purple">🔮 Purple Haze</option>
                            <option value="minimal">⚪ Minimal Gray</option>
                            <option value="cyberpunk">⚡ Cyberpunk</option>
                            <option value="industrial">🔧 Industrial</option>
                            <option value="claude">🤖 Claude</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="layoutSelector">Layout:</label>
                        <select id="layoutSelector" onchange="changeLayout()" class="form-control">
                            <option value="integrated">📱 Integrated</option>
                            <option value="tabbed">📑 Tabbed</option>
                            <option value="topbar">📊 Top Bar</option>
                            <option value="dashboard">⚙️ Dashboard</option>
                            <option value="accordion">📂 Accordion</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>🔤 Typography</h3>
                <div class="settings-grid">
                    <div class="form-group">
                        <label for="fontFamily">Font Family:</label>
                        <select id="fontFamily" onchange="changeFontFamily()" class="form-control">
                            <option value="system">System Default</option>
                            <option value="roboto">Roboto</option>
                            <option value="opensans">Open Sans</option>
                            <option value="lato">Lato</option>
                            <option value="sourcecodepro">Source Code Pro</option>
                            <option value="firacode">Fira Code</option>
                            <option value="jetbrainsmono">JetBrains Mono</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fontSize">Font Size:</label>
                        <select id="fontSize" onchange="changeFontSize()" class="form-control">
                            <option value="small">Small (90%)</option>
                            <option value="normal" selected>Normal (100%)</option>
                            <option value="large">Large (110%)</option>
                            <option value="xlarge">Extra Large (120%)</option>
                        </select>
                    </div>
                </div>
                <div class="font-preview" id="fontPreview">
                    <strong>Preview:</strong> CNC Speeds & Feeds Calculator - 21,221 RPM @ 1,167 mm/min
                </div>
            </div>

            <div class="settings-section">
                <h3>💾 Preferences</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="savePreferences()" class="btn btn-primary">Save Preferences</button>
                    <button onclick="loadPreferences()" class="btn btn-secondary">Load Saved</button>
                    <button onclick="resetPreferences()" class="btn btn-danger">Reset to Default</button>
                </div>
                <p style="margin-top: 10px; font-size: 0.9rem; color: var(--theme-text-secondary);">
                    Preferences are automatically saved and will persist across browser sessions.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Materials Database
        const ENHANCED_MATERIALS = {
            aluminum_6061: {
                name: 'Aluminum 6061-T6',
                force_coefficients: { Kc: 700, Kt: 200, Kr: 180 },
                chipload_ranges: {
                    conservative: [0.008, 0.020],
                    moderate: [0.015, 0.040], 
                    aggressive: [0.025, 0.060]
                },
                max_doc_mm: 8.0,
                specific_cutting_energy_J_mm3: 0.7
            },
            steel_1018: {
                name: 'Steel 1018 (Mild)',
                force_coefficients: { Kc: 2100, Kt: 600, Kr: 500 },
                chipload_ranges: {
                    conservative: [0.005, 0.015],
                    moderate: [0.010, 0.025],
                    aggressive: [0.015, 0.035]
                },
                max_doc_mm: 5.0,
                specific_cutting_energy_J_mm3: 2.1
            },
            steel_4140: {
                name: 'Steel 4140 (Heat Treated)',
                force_coefficients: { Kc: 2800, Kt: 800, Kr: 650 },
                chipload_ranges: {
                    conservative: [0.003, 0.010],
                    moderate: [0.008, 0.020],
                    aggressive: [0.012, 0.028]
                },
                max_doc_mm: 3.0,
                specific_cutting_energy_J_mm3: 2.8
            },
            stainless_316: {
                name: 'Stainless Steel 316',
                force_coefficients: { Kc: 2400, Kt: 700, Kr: 580 },
                chipload_ranges: {
                    conservative: [0.004, 0.012],
                    moderate: [0.009, 0.022],
                    aggressive: [0.014, 0.030]
                },
                max_doc_mm: 3.5,
                specific_cutting_energy_J_mm3: 2.4
            },
            titanium: {
                name: 'Titanium Ti-6Al-4V',
                force_coefficients: { Kc: 1800, Kt: 520, Kr: 420 },
                chipload_ranges: {
                    conservative: [0.002, 0.008],
                    moderate: [0.005, 0.015],
                    aggressive: [0.008, 0.020]
                },
                max_doc_mm: 2.0,
                specific_cutting_energy_J_mm3: 1.8
            },
            delrin: {
                name: 'Delrin (POM)',
                force_coefficients: { Kc: 400, Kt: 120, Kr: 100 },
                chipload_ranges: {
                    conservative: [0.010, 0.030],
                    moderate: [0.020, 0.050],
                    aggressive: [0.030, 0.080]
                },
                max_doc_mm: 6.0,
                specific_cutting_energy_J_mm3: 0.4
            },
            hardwood: {
                name: 'Hardwood (Oak/Maple)',
                force_coefficients: { Kc: 600, Kt: 180, Kr: 150 },
                chipload_ranges: {
                    conservative: [0.015, 0.040],
                    moderate: [0.025, 0.060],
                    aggressive: [0.040, 0.100]
                },
                max_doc_mm: 10.0,
                specific_cutting_energy_J_mm3: 0.6
            }
        };

        // Enhanced Cut Types
        const ENHANCED_CUT_TYPES = {
            slotting: { name: 'Slotting', speed_factor: 0.8, feed_factor: 0.9, doc_factor: 0.8 },
            profile: { name: 'Profile/Contour', speed_factor: 1.0, feed_factor: 1.0, doc_factor: 1.0 },
            adaptive: { name: 'Adaptive Clearing', speed_factor: 1.2, feed_factor: 1.3, doc_factor: 0.6 },
            facing: { name: 'Face Milling', speed_factor: 1.1, feed_factor: 1.2, doc_factor: 0.5 },
            roughing: { name: 'Roughing', speed_factor: 0.9, feed_factor: 1.1, doc_factor: 1.2 },
            finishing: { name: 'Finishing', speed_factor: 1.3, feed_factor: 0.8, doc_factor: 0.3 }
        };

        // Enhanced Machine Configurations
        const ENHANCED_MACHINES = {
            light_hobby: { max_feed_rate_mm_min: 1500, max_accel_mm_s2: 500, rigidity_factor: 0.6 },
            heavy_hobby: { max_feed_rate_mm_min: 3000, max_accel_mm_s2: 1000, rigidity_factor: 0.8 },
            light_industrial: { max_feed_rate_mm_min: 5000, max_accel_mm_s2: 2000, rigidity_factor: 1.0 },
            industrial: { max_feed_rate_mm_min: 8000, max_accel_mm_s2: 3000, rigidity_factor: 1.2 },
            custom: { max_feed_rate_mm_min: 3000, max_accel_mm_s2: 1000, rigidity_factor: 0.8 }
        };

        // Spindle configurations
        const SPINDLE_CONFIGS = {
            dewalt_dwp611: { power_W: 700, max_rpm: 27000, min_rpm: 16000 },
            makita_rt0701c: { power_W: 700, max_rpm: 30000, min_rpm: 10000 },
            '800w_vfd': { power_W: 800, max_rpm: 24000, min_rpm: 6000 },
            '2200w_vfd': { power_W: 2200, max_rpm: 24000, min_rpm: 8000 },
            '4000w_industrial': { power_W: 4000, max_rpm: 18000, min_rpm: 3000 },
            custom_spindle: { power_W: 2200, max_rpm: 24000, min_rpm: 8000 }
        };

        // Application State
        let appState = {
            selectedMaterials: ['aluminum_6061'],
            selectedCutTypes: ['profile'],
            aggressiveness: 1.0,
            customDOC: null,
            machineConfig: ENHANCED_MACHINES.heavy_hobby,
            currentSpindle: SPINDLE_CONFIGS['2200w_vfd'],
            currentTool: {
                type: 'flat_endmill',
                diameter_mm: 6.0,
                flutes: 2,
                stickout_mm: 25,
                material: 'carbide'
            }
        };

        // Tooltip System for interactive help
        const TooltipSystem = {
            createTooltip: function(element, content, type = 'basic') {
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip-container';
                tooltip.style.cssText = `
                    position: absolute;
                    background: var(--theme-bg-secondary);
                    border: 1px solid var(--theme-border);
                    border-radius: 8px;
                    padding: 12px;
                    box-shadow: 0 10px 25px var(--theme-shadow);
                    max-width: 350px;
                    z-index: 1000;
                    font-size: 14px;
                    line-height: 1.4;
                    display: none;
                    color: var(--theme-text-primary);
                `;
                
                if (type === 'parameter') {
                    tooltip.innerHTML = this.createParameterTooltip(content);
                } else {
                    tooltip.innerHTML = content;
                }
                
                document.body.appendChild(tooltip);
                
                element.addEventListener('mouseenter', (e) => {
                    this.positionTooltip(tooltip, e);
                    tooltip.style.display = 'block';
                });
                
                element.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
                
                element.addEventListener('mousemove', (e) => {
                    this.positionTooltip(tooltip, e);
                });
                
                return tooltip;
            },
            
            createParameterTooltip: function(paramData) {
                const { name, value, min, max, recommended, unit, status } = paramData;
                const statusColor = status === 'danger' ? '#ef4444' : 
                                  status === 'warning' ? '#f59e0b' : 
                                  status === 'good' ? '#10b981' : '#6b7280';
                
                const percentage = Math.min(Math.max((value - min) / (max - min) * 100, 0), 100);
                const recommendedPerc = Math.min(Math.max((recommended - min) / (max - min) * 100, 0), 100);
                
                return `
                    <div class="tooltip-header">
                        <strong>${name}</strong>
                        <span style="color: ${statusColor}; margin-left: 8px;">${value}${unit}</span>
                    </div>
                    <div class="parameter-range" style="margin: 8px 0;">
                        <div style="position: relative; height: 20px; background: var(--theme-bg-tertiary); border-radius: 10px; overflow: hidden;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; background: linear-gradient(to right, #ef4444, #f59e0b, #10b981); width: 100%;"></div>
                            <div style="position: absolute; left: ${recommendedPerc}%; top: 0; width: 2px; height: 100%; background: var(--theme-text-inverse); border: 1px solid var(--theme-text-primary);"></div>
                            <div style="position: absolute; left: ${percentage}%; top: 0; width: 8px; height: 100%; background: ${statusColor}; border: 2px solid var(--theme-text-inverse); margin-left: -4px; border-radius: 50%;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--theme-text-secondary); margin-top: 4px;">
                            <span>Min: ${min}${unit}</span>
                            <span>Rec: ${recommended}${unit}</span>
                            <span>Max: ${max}${unit}</span>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #6b7280;">
                        ${status === 'good' ? '✅ Parameter within safe operating range' : 
                          status === 'warning' ? '⚠️ Parameter approaching limits' : 
                          '❌ Parameter outside safe range'}
                    </div>
                `;
            },
            
            positionTooltip: function(tooltip, event) {
                const rect = tooltip.getBoundingClientRect();
                const x = event.clientX + 10;
                const y = event.clientY - rect.height - 10;
                
                tooltip.style.left = Math.min(x, window.innerWidth - rect.width - 10) + 'px';
                tooltip.style.top = Math.max(y, 10) + 'px';
            }
        };

        // Core Calculation Functions
        function getSurfaceSpeed(material, toolType) {
            const speeds = {
                aluminum_6061: 400,
                steel_1018: 120,
                steel_4140: 80,
                stainless_316: 90,
                titanium: 60,
                delrin: 600,
                hardwood: 800
            };
            return speeds[material] || 200;
        }

        function calculateSpeedsFeeds(material, cutType, tool, machine, spindle, aggressiveness, customDOC) {
            const materialData = ENHANCED_MATERIALS[material];
            const cutData = ENHANCED_CUT_TYPES[cutType];
            
            // Determine aggressiveness level
            let aggressivenessLevel = 'moderate';
            if (aggressiveness < 0.7) aggressivenessLevel = 'conservative';
            else if (aggressiveness > 1.5) aggressivenessLevel = 'aggressive';
            
            // Get chipload range
            const chiploadRange = materialData.chipload_ranges[aggressivenessLevel];
            const targetChipload = (chiploadRange[0] + chiploadRange[1]) / 2 * aggressiveness;
            
            // Calculate RPM (surface speed based)
            const surfaceSpeed = getSurfaceSpeed(material, tool.type) * cutData.speed_factor;
            const rpm = Math.round((surfaceSpeed * 1000) / (Math.PI * tool.diameter_mm));
            const clampedRPM = Math.max(spindle.min_rpm, Math.min(rpm, spindle.max_rpm));
            
            // Calculate feed rate
            const feedRate = Math.round(clampedRPM * tool.flutes * targetChipload);
            const maxFeedRate = machine.max_feed_rate_mm_min * cutData.feed_factor;
            const clampedFeedRate = Math.min(feedRate, maxFeedRate);
            
            // Calculate DOC
            let doc = customDOC;
            if (!doc) {
                doc = Math.min(
                    tool.diameter_mm * 0.5 * cutData.doc_factor * aggressiveness,
                    materialData.max_doc_mm
                );
            }
            
            // Calculate power requirement
            const MRR = tool.diameter_mm * 0.5 * doc * clampedFeedRate; // mm³/min
            const power = Math.round((MRR * materialData.specific_cutting_energy_J_mm3) / 60);
            
            // Calculate actual chipload
            const actualChipload = clampedFeedRate / (clampedRPM * tool.flutes);
            
            // Generate warnings
            const warnings = generateWarnings(power, spindle.power_W, actualChipload, chiploadRange, doc, materialData.max_doc_mm);
            
            return {
                material: materialData.name,
                cutType: cutData.name,
                rpm: clampedRPM,
                feed_mm_min: clampedFeedRate,
                chipload_mm: parseFloat(actualChipload.toFixed(4)),
                doc_mm: parseFloat(doc.toFixed(2)),
                power_W: power,
                warnings: warnings,
                status: warnings.length === 0 ? 'good' : warnings.some(w => w.severity === 'danger') ? 'danger' : 'warning'
            };
        }

        function generateWarnings(power, maxPower, chipload, chiploadRange, doc, maxDoc) {
            const warnings = [];
            
            if (power > maxPower * 0.9) {
                warnings.push({
                    severity: power > maxPower ? 'danger' : 'warning',
                    message: `Power requirement (${power}W) ${power > maxPower ? 'exceeds' : 'approaches'} spindle capacity (${maxPower}W)`
                });
            }
            
            if (chipload < chiploadRange[0] * 0.8) {
                warnings.push({
                    severity: 'warning',
                    message: `Chipload (${chipload.toFixed(4)}mm) is below recommended range - may cause tool rubbing`
                });
            }
            
            if (chipload > chiploadRange[1] * 1.2) {
                warnings.push({
                    severity: 'danger',
                    message: `Chipload (${chipload.toFixed(4)}mm) is above safe range - risk of tool breakage`
                });
            }
            
            if (doc > maxDoc) {
                warnings.push({
                    severity: 'danger',
                    message: `DOC (${doc.toFixed(2)}mm) exceeds material maximum (${maxDoc}mm)`
                });
            }
            
            return warnings;
        }

        // UI Update Functions
        function updateMachineConfig() {
            const machineType = document.getElementById('machineType').value;
            appState.machineConfig = ENHANCED_MACHINES[machineType];
            updateCalculations();
        }

        function updateSpindleConfig() {
            const spindleType = document.getElementById('spindleType').value;
            const config = SPINDLE_CONFIGS[spindleType];
            appState.currentSpindle = config;
            document.getElementById('spindlePower').value = config.power_W;
            updateCalculations();
        }

        function updateToolDefaults() {
            const toolType = document.getElementById('toolType').value;
            const toolDefaults = {
                flat_endmill: { flutes: 2, diameter: 6.0 },
                ball_endmill: { flutes: 2, diameter: 6.0 },
                chamfer_mill: { flutes: 4, diameter: 6.0 },
                vbit: { flutes: 1, diameter: 6.0 },
                drill: { flutes: 2, diameter: 6.0 },
                facemill: { flutes: 4, diameter: 20.0 }
            };
            
            if (toolDefaults[toolType]) {
                document.getElementById('toolFlutes').value = toolDefaults[toolType].flutes;
                if (toolType === 'facemill') {
                    document.getElementById('toolDiameter').value = toolDefaults[toolType].diameter;
                }
            }
            
            updateCalculations();
        }

        function toggleDOCOverride() {
            const enabled = document.getElementById('enableDOCOverride').checked;
            const controls = document.getElementById('docOverrideControls');
            const recommendations = document.getElementById('docRecommendations');
            
            if (enabled) {
                controls.style.display = 'block';
                recommendations.innerHTML = '<small><strong>Manual DOC Control Enabled</strong> - Monitor warnings carefully</small>';
                appState.customDOC = parseFloat(document.getElementById('customDOC').value);
            } else {
                controls.style.display = 'none';
                recommendations.innerHTML = '<small>Automatic DOC calculation based on tool and material properties</small>';
                appState.customDOC = null;
            }
            
            updateCalculations();
        }

        function updateAggressiveness(value) {
            appState.aggressiveness = parseFloat(value);
            document.getElementById('aggressivenessValue').textContent = value;
            updateCalculations();
        }

        function toggleMaterial(material) {
            const checkbox = document.getElementById('material_' + material);
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                if (!appState.selectedMaterials.includes(material)) {
                    appState.selectedMaterials.push(material);
                }
            } else {
                appState.selectedMaterials = appState.selectedMaterials.filter(m => m !== material);
            }
            
            updateCalculations();
        }

        function toggleCutType(cutType) {
            const checkbox = document.getElementById('cut_' + cutType);
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                if (!appState.selectedCutTypes.includes(cutType)) {
                    appState.selectedCutTypes.push(cutType);
                }
            } else {
                appState.selectedCutTypes = appState.selectedCutTypes.filter(c => c !== cutType);
            }
            
            updateCalculations();
        }

        function updateCalculations() {
            // Get current tool configuration
            appState.currentTool.diameter_mm = parseFloat(document.getElementById('toolDiameter').value);
            appState.currentTool.flutes = parseInt(document.getElementById('toolFlutes').value);
            appState.currentTool.stickout_mm = parseFloat(document.getElementById('toolStickout').value);
            
            // Get current spindle configuration
            appState.currentSpindle.power_W = parseFloat(document.getElementById('spindlePower').value);
            
            // Get custom DOC if enabled
            if (document.getElementById('enableDOCOverride').checked) {
                appState.customDOC = parseFloat(document.getElementById('customDOC').value);
            }
            
            // Calculate results for all selected combinations
            const results = [];
            const warnings = [];
            
            appState.selectedMaterials.forEach(material => {
                appState.selectedCutTypes.forEach(cutType => {
                    const result = calculateSpeedsFeeds(
                        material,
                        cutType,
                        appState.currentTool,
                        appState.machineConfig,
                        appState.currentSpindle,
                        appState.aggressiveness,
                        appState.customDOC
                    );
                    results.push(result);
                    warnings.push(...result.warnings);
                });
            });
            
            displayResults(results);
            updateDOCWarnings(warnings);
            initializeTooltips();
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';
            
            results.forEach((result, index) => {
                const row = document.createElement('tr');
                
                const statusIcon = result.status === 'good' ? '✅' : 
                                 result.status === 'warning' ? '⚠️' : '❌';
                
                row.innerHTML = `
                    <td>${result.material}</td>
                    <td>${result.cutType}</td>
                    <td class="result-value" data-param="rpm" data-value="${result.rpm}" data-min="8000" data-max="24000" data-recommended="15000" data-unit="">${result.rpm}</td>
                    <td class="result-value" data-param="feed" data-value="${result.feed_mm_min}" data-min="100" data-max="3000" data-recommended="1000" data-unit=" mm/min">${result.feed_mm_min}</td>
                    <td class="result-value" data-param="chipload" data-value="${result.chipload_mm}" data-min="0.005" data-max="0.060" data-recommended="0.025" data-unit=" mm">${result.chipload_mm}</td>
                    <td class="result-value" data-param="doc" data-value="${result.doc_mm}" data-min="0.5" data-max="8" data-recommended="3" data-unit=" mm">${result.doc_mm}</td>
                    <td class="result-value" data-param="power" data-value="${result.power_W}" data-min="50" data-max="${appState.currentSpindle.power_W}" data-recommended="${appState.currentSpindle.power_W * 0.7}" data-unit=" W">${result.power_W}</td>
                    <td>${statusIcon}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateDOCWarnings(warnings) {
            const warningsDiv = document.getElementById('docWarnings');
            if (warnings.length === 0) {
                warningsDiv.innerHTML = '';
                return;
            }
            
            const warningHTML = warnings.map(warning => {
                const color = warning.severity === 'danger' ? '#ef4444' : '#f59e0b';
                const icon = warning.severity === 'danger' ? '❌' : '⚠️';
                return `<div style="color: ${color}; font-size: 12px; margin: 2px 0;">${icon} ${warning.message}</div>`;
            }).join('');
            
            warningsDiv.innerHTML = warningHTML;
        }

        function initializeTooltips() {
            // Remove existing tooltips
            document.querySelectorAll('.tooltip-container').forEach(tooltip => tooltip.remove());
            
            // Initialize parameter tooltips
            document.querySelectorAll('.result-value').forEach(element => {
                const param = element.getAttribute('data-param');
                const value = parseFloat(element.getAttribute('data-value'));
                const min = parseFloat(element.getAttribute('data-min'));
                const max = parseFloat(element.getAttribute('data-max'));
                const recommended = parseFloat(element.getAttribute('data-recommended'));
                const unit = element.getAttribute('data-unit') || '';
                
                if (param && !isNaN(value)) {
                    // Determine status
                    let status = 'good';
                    if (value > recommended * 1.5 || value < recommended * 0.3) {
                        status = 'danger';
                    } else if (value > recommended * 1.2 || value < recommended * 0.5) {
                        status = 'warning';
                    }
                    
                    const paramData = {
                        name: param.charAt(0).toUpperCase() + param.slice(1),
                        value: value,
                        min: min,
                        max: max,
                        recommended: recommended,
                        unit: unit,
                        status: status
                    };
                    
                    TooltipSystem.createTooltip(element, paramData, 'parameter');
                }
            });
        }

        // Export/Import Functions
        function exportSettings() {
            const settings = {
                machine: document.getElementById('machineType').value,
                spindle: {
                    type: document.getElementById('spindleType').value,
                    power: appState.currentSpindle.power_W
                },
                tool: appState.currentTool,
                materials: appState.selectedMaterials,
                cutTypes: appState.selectedCutTypes,
                aggressiveness: appState.aggressiveness,
                customDOC: appState.customDOC,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cnc-speeds-feeds-settings-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importSettings(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const settings = JSON.parse(e.target.result);
                        
                        // Restore machine settings
                        if (settings.machine) {
                            document.getElementById('machineType').value = settings.machine;
                            updateMachineConfig();
                        }
                        
                        // Restore spindle settings
                        if (settings.spindle) {
                            document.getElementById('spindleType').value = settings.spindle.type;
                            updateSpindleConfig();
                        }
                        
                        // Restore tool settings
                        if (settings.tool) {
                            document.getElementById('toolDiameter').value = settings.tool.diameter_mm;
                            document.getElementById('toolFlutes').value = settings.tool.flutes;
                            document.getElementById('toolStickout').value = settings.tool.stickout_mm;
                        }
                        
                        // Restore material selections
                        if (settings.materials) {
                            // Clear all materials first
                            appState.selectedMaterials = [];
                            document.querySelectorAll('[id^="material_"]').forEach(cb => cb.checked = false);
                            
                            // Set selected materials
                            settings.materials.forEach(material => {
                                const checkbox = document.getElementById('material_' + material);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    appState.selectedMaterials.push(material);
                                }
                            });
                        }
                        
                        // Restore cut type selections
                        if (settings.cutTypes) {
                            // Clear all cut types first
                            appState.selectedCutTypes = [];
                            document.querySelectorAll('[id^="cut_"]').forEach(cb => cb.checked = false);
                            
                            // Set selected cut types
                            settings.cutTypes.forEach(cutType => {
                                const checkbox = document.getElementById('cut_' + cutType);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    appState.selectedCutTypes.push(cutType);
                                }
                            });
                        }
                        
                        // Restore aggressiveness
                        if (settings.aggressiveness) {
                            document.getElementById('aggressivenessSlider').value = settings.aggressiveness;
                            updateAggressiveness(settings.aggressiveness);
                        }
                        
                        // Restore DOC override
                        if (settings.customDOC !== null && settings.customDOC !== undefined) {
                            document.getElementById('enableDOCOverride').checked = true;
                            document.getElementById('customDOC').value = settings.customDOC;
                            toggleDOCOverride();
                        }
                        
                        updateCalculations();
                        alert('Settings imported successfully!');
                        
                    } catch (error) {
                        alert('Invalid settings file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
            
            // Reset the input
            event.target.value = '';
        }
        
        // Theme switching functions
        let currentTheme = 'default';
        
        function changeTheme() {
            const selector = document.getElementById('themeSelector');
            const newTheme = selector.value;
            currentTheme = newTheme;
            
            // Remove existing theme classes
            document.body.classList.remove(
                'theme-default', 'theme-dark', 'theme-light', 'theme-ocean', 
                'theme-forest', 'theme-sunset', 'theme-purple', 'theme-minimal', 
                'theme-cyberpunk', 'theme-industrial', 'theme-claude'
            );
            
            // Apply new theme class
            if (newTheme !== 'default') {
                document.body.classList.add(`theme-${newTheme}`);
            }
            
            // Auto-save preferences
            autoSavePreferences();
        }
        
        // Load saved theme on page load
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('preferredTheme');
            if (savedTheme) {
                currentTheme = savedTheme;
                document.getElementById('themeSelector').value = savedTheme;
                changeTheme();
            }
        }

        // Layout switching functions  
        let currentLayout = 'integrated';
        let originalInputSection = null;
        let originalResultsSection = null;
        
        function changeLayout() {
            const selector = document.getElementById('layoutSelector');
            const newLayout = selector.value;
            currentLayout = newLayout;
            
            // Store original sections if not already stored
            if (!originalInputSection) {
                originalInputSection = document.querySelector('.input-section').cloneNode(true);
                originalResultsSection = document.querySelector('.results-section').cloneNode(true);
            }
            
            const gridContainer = document.querySelector('.grid');
            
            // Reset grid classes
            gridContainer.className = 'grid';
            
            // Apply new layout
            switch (newLayout) {
                case 'integrated':
                    renderIntegratedLayout();
                    break;
                case 'tabbed':
                    renderTabbedLayout();
                    break;
                case 'topbar':
                    renderTopBarLayout();
                    break;
                case 'dashboard':
                    renderDashboardLayout();
                    break;
                case 'accordion':
                    renderAccordionLayout();
                    break;
            }
            
            // Auto-save preferences
            autoSavePreferences();
        }
        
        function renderIntegratedLayout() {
            const gridContainer = document.querySelector('.grid');
            gridContainer.className = 'grid';
            
            // Restore original two-column layout
            gridContainer.innerHTML = '';
            gridContainer.appendChild(originalInputSection.cloneNode(true));
            gridContainer.appendChild(originalResultsSection.cloneNode(true));
            
            // Restore event handlers
            restoreEventHandlers();
        }
        
        function renderTabbedLayout() {
            const gridContainer = document.querySelector('.grid');
            gridContainer.className = 'grid tabbed';
            
            // Create tab container
            const tabContainer = document.createElement('div');
            tabContainer.className = 'tab-container';
            tabContainer.innerHTML = `
                <div class="tab-nav">
                    <button class="tab-button active" onclick="switchTab('config-tab')">🔧 Configuration</button>
                    <button class="tab-button" onclick="switchTab('results-tab')">📊 Results</button>
                </div>
                <div class="tab-content">
                    <div class="tab-panel active" id="config-tab"></div>
                    <div class="tab-panel" id="results-tab"></div>
                </div>
            `;
            
            // Move content to tabs
            const configTab = tabContainer.querySelector('#config-tab');
            const resultsTab = tabContainer.querySelector('#results-tab');
            
            configTab.appendChild(originalInputSection.cloneNode(true));
            resultsTab.appendChild(originalResultsSection.cloneNode(true));
            
            // Replace grid content
            gridContainer.innerHTML = '';
            gridContainer.appendChild(tabContainer);
            
            // Restore event handlers
            restoreEventHandlers();
        }
        
        function renderTopBarLayout() {
            const gridContainer = document.querySelector('.grid');
            gridContainer.className = 'grid topbar';
            
            // Create top bar with key controls
            const topBar = document.createElement('div');
            topBar.className = 'topbar-controls';
            topBar.innerHTML = `
                <h3>🎛️ Quick Controls</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Machine:</label>
                        <select id="topbar-machine" onchange="syncControl('machineType', this.value)">
                            <option value="light_hobby">Light Hobby</option>
                            <option value="heavy_hobby" selected>PrintNC / Heavy Hobby</option>
                            <option value="light_industrial">Light Industrial</option>
                            <option value="industrial">Industrial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tool Diameter (mm):</label>
                        <input type="number" id="topbar-diameter" value="6" min="0.5" max="25" step="0.5" onchange="syncControl('toolDiameter', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Aggressiveness:</label>
                        <input type="range" id="topbar-aggressiveness" min="0" max="100" value="50" onchange="syncControl('aggressiveness', this.value)">
                    </div>
                </div>
            `;
            
            gridContainer.innerHTML = '';
            gridContainer.appendChild(topBar);
            gridContainer.appendChild(originalInputSection.cloneNode(true));
            gridContainer.appendChild(originalResultsSection.cloneNode(true));
            
            // Restore event handlers
            restoreEventHandlers();
        }
        
        function renderDashboardLayout() {
            const gridContainer = document.querySelector('.grid');
            gridContainer.className = 'grid dashboard';
            
            // Create dashboard cards
            const inputClone = originalInputSection.cloneNode(true);
            const machineConfig = inputClone.querySelector('.machine-config');
            const docOverride = inputClone.querySelector('.doc-override');
            
            const cards = [
                { title: '🏭 Machine Setup', content: machineConfig },
                { title: '🎯 DOC Override', content: docOverride },
                { title: '📊 Results', content: originalResultsSection.cloneNode(true) }
            ];
            
            gridContainer.innerHTML = '';
            cards.forEach(card => {
                if (card.content) {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'input-section';
                    cardDiv.innerHTML = `<h2>${card.title}</h2>`;
                    cardDiv.appendChild(card.content);
                    gridContainer.appendChild(cardDiv);
                }
            });
            
            // Add remaining input content
            const remainingCard = document.createElement('div');
            remainingCard.className = 'input-section';
            remainingCard.innerHTML = '<h2>🔧 Tool & Materials</h2>';
            
            // Copy remaining content
            const remainingContent = inputClone.cloneNode(true);
            // Remove already used sections
            const machineToRemove = remainingContent.querySelector('.machine-config');
            const docToRemove = remainingContent.querySelector('.doc-override');
            if (machineToRemove) machineToRemove.remove();
            if (docToRemove) docToRemove.remove();
            
            remainingCard.appendChild(remainingContent);
            gridContainer.appendChild(remainingCard);
            
            // Restore event handlers
            restoreEventHandlers();
        }
        
        function renderAccordionLayout() {
            const gridContainer = document.querySelector('.grid');
            gridContainer.className = 'grid accordion';
            
            const inputClone = originalInputSection.cloneNode(true);
            const machineConfig = inputClone.querySelector('.machine-config');
            const docOverride = inputClone.querySelector('.doc-override');
            
            const sections = [
                { title: '🏭 Machine Configuration', id: 'machine-acc', content: machineConfig },
                { title: '🎯 DOC Override', id: 'doc-acc', content: docOverride },
                { title: '📊 Results & Analysis', id: 'results-acc', content: originalResultsSection.cloneNode(true), active: true }
            ];
            
            gridContainer.innerHTML = '';
            sections.forEach(section => {
                if (section.content) {
                    const accordion = document.createElement('div');
                    accordion.className = 'accordion-section';
                    accordion.innerHTML = `
                        <div class="accordion-header ${section.active ? 'active' : ''}" onclick="toggleAccordion('${section.id}')">
                            <span>${section.title}</span>
                            <span class="accordion-arrow">▼</span>
                        </div>
                        <div class="accordion-content ${section.active ? 'active' : ''}" id="${section.id}"></div>
                    `;
                    
                    const content = accordion.querySelector('.accordion-content');
                    content.appendChild(section.content);
                    gridContainer.appendChild(accordion);
                }
            });
            
            // Add remaining content accordion
            const remainingContent = inputClone.cloneNode(true);
            const machineToRemove = remainingContent.querySelector('.machine-config');
            const docToRemove = remainingContent.querySelector('.doc-override');
            if (machineToRemove) machineToRemove.remove();
            if (docToRemove) docToRemove.remove();
            
            if (remainingContent.children.length > 1) { // More than just the h2
                const accordion = document.createElement('div');
                accordion.className = 'accordion-section';
                accordion.innerHTML = `
                    <div class="accordion-header" onclick="toggleAccordion('tools-acc')">
                        <span>🔧 Tool & Materials</span>
                        <span class="accordion-arrow">▼</span>
                    </div>
                    <div class="accordion-content" id="tools-acc"></div>
                `;
                
                const content = accordion.querySelector('.accordion-content');
                content.appendChild(remainingContent);
                gridContainer.appendChild(accordion);
            }
            
            // Restore event handlers
            restoreEventHandlers();
        }
        
        // Function to restore event handlers after layout changes
        function restoreEventHandlers() {
            // Re-bind machine type change handler
            const machineSelect = document.getElementById('machineType');
            if (machineSelect) {
                machineSelect.onchange = updateMachineConfig;
            }
            
            // Re-bind spindle type change handler
            const spindleSelect = document.getElementById('spindleType');
            if (spindleSelect) {
                spindleSelect.onchange = function() { updateCalculations(); };
            }
            
            // Re-bind tool type change handler
            const toolSelect = document.getElementById('toolType');
            if (toolSelect) {
                toolSelect.onchange = function() { updateCalculations(); };
            }
            
            // Re-bind other input handlers
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.id && !input.onchange && !input.onclick) {
                    if (input.type === 'checkbox' && input.id.startsWith('material_')) {
                        // Don't override existing handlers
                    } else if (input.type === 'range' && input.id === 'aggressiveness') {
                        input.oninput = function() { updateAggressiveness(this.value); };
                    } else if (input.type === 'checkbox' && input.id === 'enableDOCOverride') {
                        input.onchange = toggleDOCOverride;
                    } else {
                        input.onchange = function() { updateCalculations(); };
                    }
                }
            });
        }
        
        // Helper functions for layout interactions
        function switchTab(tabId) {
            // Remove active class from all tabs and buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
        
        function toggleAccordion(accordionId) {
            const content = document.getElementById(accordionId);
            const header = content.previousElementSibling;
            
            content.classList.toggle('active');
            header.classList.toggle('active');
        }
        
        function syncControl(targetId, value) {
            const target = document.getElementById(targetId);
            if (target) {
                target.value = value;
                if (target.onchange) target.onchange();
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved theme
            loadSavedTheme();
            
            // Store original content for layout switching
            originalInputSection = document.querySelector('.input-section').cloneNode(true);
            originalResultsSection = document.querySelector('.results-section').cloneNode(true);
            
            updateCalculations();
        });

        // Settings Panel Functions
        let settingsOpen = false;

        function toggleSettings() {
            const overlay = document.getElementById('settingsOverlay');
            settingsOpen = !settingsOpen;
            overlay.style.display = settingsOpen ? 'flex' : 'none';
            
            if (settingsOpen) {
                // Update font preview when opening
                updateFontPreview();
            }
        }

        function closeSettingsOnOverlay(event) {
            if (event.target === document.getElementById('settingsOverlay')) {
                toggleSettings();
            }
        }

        // Font Management Functions
        let currentFontFamily = 'system';
        let currentFontSize = 'normal';

        function changeFontFamily() {
            const selector = document.getElementById('fontFamily');
            currentFontFamily = selector.value;
            applyFontSettings();
            updateFontPreview();
            savePreferences();
        }

        function changeFontSize() {
            const selector = document.getElementById('fontSize');
            currentFontSize = selector.value;
            applyFontSettings();
            updateFontPreview();
            savePreferences();
        }

        function applyFontSettings() {
            const fontFamilies = {
                'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif',
                'roboto': '"Roboto", sans-serif',
                'opensans': '"Open Sans", sans-serif',
                'lato': '"Lato", sans-serif',
                'sourcecodepro': '"Source Code Pro", monospace',
                'firacode': '"Fira Code", monospace',
                'jetbrainsmono': '"JetBrains Mono", monospace'
            };

            const fontSizes = {
                'small': '0.9',
                'normal': '1.0',
                'large': '1.1',
                'xlarge': '1.2'
            };

            // Load Google Fonts if needed
            if (['roboto', 'opensans', 'lato', 'sourcecodepro', 'firacode', 'jetbrainsmono'].includes(currentFontFamily)) {
                loadGoogleFont(currentFontFamily);
            }

            document.body.style.fontFamily = fontFamilies[currentFontFamily];
            document.body.style.fontSize = `${fontSizes[currentFontSize]}rem`;
        }

        function loadGoogleFont(fontName) {
            const existingLink = document.getElementById('googleFont');
            if (existingLink) {
                existingLink.remove();
            }

            const fontUrls = {
                'roboto': 'https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap',
                'opensans': 'https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;700&display=swap',
                'lato': 'https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap',
                'sourcecodepro': 'https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300;400;500;700&display=swap',
                'firacode': 'https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;700&display=swap',
                'jetbrainsmono': 'https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&display=swap'
            };

            if (fontUrls[fontName]) {
                const link = document.createElement('link');
                link.id = 'googleFont';
                link.rel = 'stylesheet';
                link.href = fontUrls[fontName];
                document.head.appendChild(link);
            }
        }

        function updateFontPreview() {
            const preview = document.getElementById('fontPreview');
            const fontFamilies = {
                'system': 'System Default',
                'roboto': 'Roboto',
                'opensans': 'Open Sans',
                'lato': 'Lato',
                'sourcecodepro': 'Source Code Pro',
                'firacode': 'Fira Code',
                'jetbrainsmono': 'JetBrains Mono'
            };

            const fontSizes = {
                'small': 'Small (90%)',
                'normal': 'Normal (100%)',
                'large': 'Large (110%)',
                'xlarge': 'Extra Large (120%)'
            };

            preview.innerHTML = `
                <strong>Preview (${fontFamilies[currentFontFamily]} - ${fontSizes[currentFontSize]}):</strong><br>
                CNC Speeds & Feeds Calculator - 21,221 RPM @ 1,167 mm/min<br>
                <small>0123456789 ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz</small>
            `;
        }

        // Preferences Management with localStorage
        function savePreferences() {
            const preferences = {
                theme: currentTheme,
                layout: currentLayout,
                fontFamily: currentFontFamily,
                fontSize: currentFontSize,
                timestamp: new Date().toISOString()
            };

            try {
                localStorage.setItem('cnc-calculator-preferences', JSON.stringify(preferences));
                
                // Show feedback - check if called from button click
                if (window.event && window.event.target) {
                    const btn = window.event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '✅ Saved!';
                    btn.style.background = 'var(--theme-success)';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                }
            } catch (error) {
                console.warn('Could not save preferences:', error);
                // Only show alert if called from manual save button
                if (window.event && window.event.target) {
                    alert('Could not save preferences. Local storage may be disabled.');
                }
            }
        }

        function loadPreferences() {
            try {
                const saved = localStorage.getItem('cnc-calculator-preferences');
                if (saved) {
                    const preferences = JSON.parse(saved);
                    
                    // Apply preferences
                    if (preferences.theme) {
                        currentTheme = preferences.theme;
                        document.getElementById('themeSelector').value = preferences.theme;
                        changeTheme();
                    }
                    
                    if (preferences.layout) {
                        currentLayout = preferences.layout;
                        document.getElementById('layoutSelector').value = preferences.layout;
                        changeLayout();
                    }
                    
                    if (preferences.fontFamily) {
                        currentFontFamily = preferences.fontFamily;
                        document.getElementById('fontFamily').value = preferences.fontFamily;
                        applyFontSettings();
                    }
                    
                    if (preferences.fontSize) {
                        currentFontSize = preferences.fontSize;
                        document.getElementById('fontSize').value = preferences.fontSize;
                        applyFontSettings();
                    }

                    updateFontPreview();
                    
                    // Show feedback - check if called from button click
                    if (window.event && window.event.target) {
                        const btn = window.event.target;
                        const originalText = btn.textContent;
                        btn.textContent = '✅ Loaded!';
                        btn.style.background = 'var(--theme-success)';
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.style.background = '';
                        }, 2000);
                    }
                } else {
                    alert('No saved preferences found.');
                }
            } catch (error) {
                console.warn('Could not load preferences:', error);
                alert('Could not load preferences.');
            }
        }

        function resetPreferences() {
            if (confirm('Reset all preferences to default? This cannot be undone.')) {
                // Clear localStorage
                try {
                    localStorage.removeItem('cnc-calculator-preferences');
                } catch (error) {
                    console.warn('Could not clear preferences:', error);
                }

                // Reset to defaults
                currentTheme = 'default';
                currentLayout = 'integrated';
                currentFontFamily = 'system';
                currentFontSize = 'normal';

                // Update UI
                document.getElementById('themeSelector').value = 'default';
                document.getElementById('layoutSelector').value = 'integrated';
                document.getElementById('fontFamily').value = 'system';
                document.getElementById('fontSize').value = 'normal';

                // Apply changes
                changeTheme();
                changeLayout();
                applyFontSettings();
                updateFontPreview();

                // Show feedback - check if called from button click
                if (window.event && window.event.target) {
                    const btn = window.event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '✅ Reset!';
                    btn.style.background = 'var(--theme-success)';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                }
            }
        }

        // Auto-load preferences on page load
        function autoLoadPreferences() {
            try {
                const saved = localStorage.getItem('cnc-calculator-preferences');
                if (saved) {
                    const preferences = JSON.parse(saved);
                    
                    if (preferences.theme) {
                        currentTheme = preferences.theme;
                        document.getElementById('themeSelector').value = preferences.theme;
                        changeTheme();
                    }
                    
                    if (preferences.layout) {
                        currentLayout = preferences.layout;
                        document.getElementById('layoutSelector').value = preferences.layout;
                        changeLayout();
                    }
                    
                    if (preferences.fontFamily) {
                        currentFontFamily = preferences.fontFamily;
                        document.getElementById('fontFamily').value = preferences.fontFamily;
                        applyFontSettings();
                    }
                    
                    if (preferences.fontSize) {
                        currentFontSize = preferences.fontSize;
                        document.getElementById('fontSize').value = preferences.fontSize;
                        applyFontSettings();
                    }
                }
            } catch (error) {
                console.warn('Could not auto-load preferences:', error);
            }
        }

        // Auto-save preferences when settings change
        function autoSavePreferences() {
            setTimeout(() => {
                savePreferences();
            }, 500);
        }

        // Load preferences when page loads
        document.addEventListener('DOMContentLoaded', autoLoadPreferences);
    </script>
</body>
</html>