<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JustTheChip v2.0 - CNC Speeds & Feeds Calculator</title>
    <meta name="description" content="Professional CNC speeds and feeds calculator with enhanced machine configuration, DOC override, and validated formulas">
    
    <!-- Minimal CSS for core functionality - no external dependencies -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f8fafc;
            color: #374151;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border-radius: 12px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .panel h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1f2937;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #374151;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .checkbox-item:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        
        .checkbox-item.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .checkbox-item input {
            margin-right: 10px;
            width: auto;
        }
        
        .button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 5px;
        }
        
        .button:hover {
            background-color: #2563eb;
        }
        
        .button.secondary {
            background-color: #6b7280;
        }
        
        .button.secondary:hover {
            background-color: #4b5563;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .results-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        
        .results-table tr:hover {
            background-color: #f8fafc;
        }
        
        .warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            color: #92400e;
        }
        
        .danger {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            color: #dc2626;
        }
        
        .success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            color: #065f46;
        }
        
        .slider-container {
            margin: 20px 0;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #d1d5db;
            outline: none;
            appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
        }
        
        .version-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #10b981;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .doc-override {
            background-color: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .doc-override h3 {
            color: #0ea5e9;
            margin-bottom: 10px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #3b82f6;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .enhanced-motor-config {
            background-color: #fefce8;
            border: 2px solid #eab308;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .enhanced-motor-config h3 {
            color: #a16207;
            margin-bottom: 10px;
        }
        
        .motor-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .motor-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="version-badge">v2.0</div>
    
    <div class="container">
        <div class="header">
            <h1>JustTheChip v2.0</h1>
            <p>Professional CNC Speeds & Feeds Calculator with Enhanced Features</p>
        </div>
        
        <div class="grid">
            <!-- Left Panel: Configuration -->
            <div class="panel">
                <h2>🔧 Machine & Tool Configuration</h2>
                
                <!-- Enhanced Machine Configuration -->
                <div class="enhanced-motor-config">
                    <h3>Enhanced Machine Configuration</h3>
                    <div class="form-group">
                        <label for="machineType">Machine Type:</label>
                        <select id="machineType" onchange="updateMachineConfig()">
                            <option value="hobby">Light Hobby Machine</option>
                            <option value="printnc" selected>PrintNC / Heavy Hobby</option>
                            <option value="light_industrial">Light Industrial</option>
                            <option value="industrial">Industrial Machine</option>
                            <option value="custom">Custom Configuration</option>
                        </select>
                    </div>
                    
                    <div class="motor-details">
                        <div class="form-group">
                            <label for="motorType">Motor Type:</label>
                            <select id="motorType" onchange="updateMotorSpecs()">
                                <option value="stepper">NEMA 23/34 Stepper</option>
                                <option value="ac_servo">AC Servo Motor</option>
                                <option value="dc_servo">DC Servo Motor</option>
                                <option value="brushless_dc">Brushless DC Motor</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="driveSystem">Drive System:</label>
                            <select id="driveSystem">
                                <option value="ballscrew">Ball Screw (C5/C7)</option>
                                <option value="leadscrew">Lead Screw (Acme)</option>
                                <option value="belt_drive">Belt Drive (GT2)</option>
                                <option value="rack_pinion">Rack & Pinion</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="motorTorque">Motor Torque (Nm):</label>
                            <input type="number" id="motorTorque" step="0.1" min="0.1" value="3.0">
                        </div>
                        
                        <div class="form-group">
                            <label for="maxRPM">Max Motor RPM:</label>
                            <input type="number" id="maxRPM" step="100" min="100" value="3000">
                        </div>
                    </div>
                </div>
                
                <!-- Spindle Configuration -->
                <div class="form-group">
                    <label for="spindleType">Spindle Type:</label>
                    <select id="spindleType" onchange="updateSpindleConfig()">
                        <option value="router_dewalt">DeWalt DWP611 Router</option>
                        <option value="router_makita">Makita RT0701C Router</option>
                        <option value="spindle_800w">800W VFD Spindle</option>
                        <option value="spindle_2200w" selected>2.2kW VFD Spindle</option>
                        <option value="spindle_4000w">4kW Industrial Spindle</option>
                        <option value="custom_spindle">Custom Spindle</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="spindlePower">Spindle Power (W):</label>
                    <input type="number" id="spindlePower" step="100" min="100" value="2200">
                </div>
                
                <!-- Tool Configuration -->
                <div class="form-group">
                    <label for="toolType">Tool Type:</label>
                    <select id="toolType" onchange="updateToolConfig()">
                        <option value="endmill_flat" selected>Flat End Mill</option>
                        <option value="endmill_ball">Ball End Mill</option>
                        <option value="chamfer">Chamfer Mill</option>
                        <option value="vbit">V-Bit / V-Carve</option>
                        <option value="drill">Drill Bit</option>
                        <option value="facemill">Face Mill (Insert)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="toolDiameter">Tool Diameter (mm):</label>
                    <input type="number" id="toolDiameter" step="0.1" min="0.1" value="6.0">
                </div>
                
                <div class="form-group">
                    <label for="toolFlutes">Number of Flutes:</label>
                    <input type="number" id="toolFlutes" step="1" min="1" value="2">
                </div>
                
                <div class="form-group">
                    <label for="toolStickout">Tool Stickout (mm):</label>
                    <input type="number" id="toolStickout" step="1" min="5" value="25">
                </div>
                
                <!-- Enhanced DOC Override -->
                <div class="doc-override">
                    <h3>🎯 Depth of Cut (DOC) Override</h3>
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableDOCOverride" onchange="toggleDOCOverride()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span style="margin-left: 15px;">Enable Manual DOC Control</span>
                    </div>
                    
                    <div id="docOverrideControls" style="display: none;">
                        <div class="form-group">
                            <label for="customDOC">Custom DOC (mm):</label>
                            <input type="number" id="customDOC" step="0.1" min="0.1" value="1.0" onchange="updateCalculations()">
                        </div>
                        <div id="docWarnings"></div>
                    </div>
                    
                    <div id="docRecommendations">
                        <small>Automatic DOC calculation based on tool and material properties</small>
                    </div>
                </div>
                
                <!-- Material Selection -->
                <div class="form-group">
                    <label>Materials to Calculate:</label>
                    <div class="checkbox-group" id="materialSelection">
                        <!-- Materials will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Cut Type Selection -->
                <div class="form-group">
                    <label>Cut Types:</label>
                    <div class="checkbox-group" id="cutTypeSelection">
                        <!-- Cut types will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Aggressiveness Slider -->
                <div class="slider-container">
                    <label for="aggressiveness">Aggressiveness Factor: <span id="aggressivenessValue">1.0</span></label>
                    <input type="range" id="aggressiveness" class="slider" min="0.1" max="3.0" step="0.1" value="1.0" 
                           oninput="updateAggressiveness(this.value)">
                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #6b7280;">
                        <span>Conservative</span>
                        <span>Moderate</span>
                        <span>Aggressive</span>
                    </div>
                </div>
                
                <!-- Export/Import -->
                <div style="text-align: center; margin-top: 25px;">
                    <button class="button" onclick="exportSettings()">Export Settings</button>
                    <button class="button secondary" onclick="importSettings()">Import Settings</button>
                    <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleImport(event)">
                </div>
            </div>
            
            <!-- Right Panel: Results -->
            <div class="panel">
                <h2>📊 Calculation Results</h2>
                
                <div id="resultsContainer">
                    <div class="success">
                        Ready to calculate! Select materials and cut types, then adjust parameters as needed.
                    </div>
                </div>
                
                <div id="warningsContainer"></div>
                
                <table id="resultsTable" class="results-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Cut Type</th>
                            <th>RPM</th>
                            <th>Feed (mm/min)</th>
                            <th>Chipload (mm)</th>
                            <th>DOC (mm)</th>
                            <th>Power (W)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Enhanced Data Models from v2.0
        
        // Enhanced Machine Configurations
        const ENHANCED_MACHINES = {
            hobby: {
                name: 'Light Hobby Machine',
                motors: {
                    type: 'stepper',
                    torque_Nm: 1.0,
                    max_rpm: 2000,
                    drive_system: 'leadscrew'
                },
                max_feed_rate_mm_min: 2000,
                stiffness_rating: 0.3
            },
            printnc: {
                name: 'PrintNC / Heavy Hobby',
                motors: {
                    type: 'stepper', 
                    torque_Nm: 3.0,
                    max_rpm: 3000,
                    drive_system: 'ballscrew'
                },
                max_feed_rate_mm_min: 5000,
                stiffness_rating: 0.7
            },
            light_industrial: {
                name: 'Light Industrial',
                motors: {
                    type: 'ac_servo',
                    torque_Nm: 5.0,
                    max_rpm: 4000,
                    drive_system: 'ballscrew'
                },
                max_feed_rate_mm_min: 8000,
                stiffness_rating: 0.85
            },
            industrial: {
                name: 'Industrial Machine',
                motors: {
                    type: 'ac_servo',
                    torque_Nm: 10.0,
                    max_rpm: 6000,
                    drive_system: 'ballscrew'
                },
                max_feed_rate_mm_min: 15000,
                stiffness_rating: 0.95
            }
        };
        
        // Enhanced Materials Database with Validated Coefficients
        const ENHANCED_MATERIALS = {
            al_6061_t6: {
                name: 'Aluminum 6061-T6',
                force_coefficients: { Kc: 700, Kt: 200, Kr: 180 },
                chipload_ranges: {
                    conservative: [0.008, 0.020],
                    moderate: [0.015, 0.040], 
                    aggressive: [0.025, 0.060]
                },
                max_doc_mm: 8.0,
                specific_cutting_energy_J_mm3: 0.7
            },
            steel_1018: {
                name: 'Steel 1018 (Mild)',
                force_coefficients: { Kc: 2100, Kt: 600, Kr: 500 },
                chipload_ranges: {
                    conservative: [0.005, 0.015],
                    moderate: [0.010, 0.025],
                    aggressive: [0.015, 0.035]
                },
                max_doc_mm: 5.0,
                specific_cutting_energy_J_mm3: 2.1
            },
            steel_4140: {
                name: 'Steel 4140 (Heat Treated)',
                force_coefficients: { Kc: 2800, Kt: 800, Kr: 650 },
                chipload_ranges: {
                    conservative: [0.003, 0.010],
                    moderate: [0.008, 0.020],
                    aggressive: [0.012, 0.028]
                },
                max_doc_mm: 3.0,
                specific_cutting_energy_J_mm3: 2.8
            },
            stainless_316: {
                name: 'Stainless Steel 316',
                force_coefficients: { Kc: 2400, Kt: 700, Kr: 580 },
                chipload_ranges: {
                    conservative: [0.004, 0.012],
                    moderate: [0.009, 0.022],
                    aggressive: [0.014, 0.030]
                },
                max_doc_mm: 3.5,
                specific_cutting_energy_J_mm3: 2.4
            },
            titanium_6al4v: {
                name: 'Titanium Ti-6Al-4V',
                force_coefficients: { Kc: 1800, Kt: 520, Kr: 420 },
                chipload_ranges: {
                    conservative: [0.002, 0.008],
                    moderate: [0.005, 0.015],
                    aggressive: [0.008, 0.020]
                },
                max_doc_mm: 2.0,
                specific_cutting_energy_J_mm3: 1.8
            },
            delrin: {
                name: 'Delrin (POM)',
                force_coefficients: { Kc: 400, Kt: 120, Kr: 100 },
                chipload_ranges: {
                    conservative: [0.010, 0.030],
                    moderate: [0.020, 0.050],
                    aggressive: [0.030, 0.080]
                },
                max_doc_mm: 6.0,
                specific_cutting_energy_J_mm3: 0.4
            },
            hardwood: {
                name: 'Hardwood (Oak/Maple)',
                force_coefficients: { Kc: 600, Kt: 180, Kr: 150 },
                chipload_ranges: {
                    conservative: [0.015, 0.040],
                    moderate: [0.025, 0.060],
                    aggressive: [0.040, 0.100]
                },
                max_doc_mm: 10.0,
                specific_cutting_energy_J_mm3: 0.6
            }
        };
        
        // Enhanced Cut Types
        const ENHANCED_CUT_TYPES = {
            slot: { name: 'Slotting', speed_factor: 0.8, feed_factor: 0.9, doc_factor: 0.8 },
            profile: { name: 'Profile/Contour', speed_factor: 1.0, feed_factor: 1.0, doc_factor: 1.0 },
            adaptive: { name: 'Adaptive Clearing', speed_factor: 1.2, feed_factor: 1.3, doc_factor: 0.6 },
            facing: { name: 'Face Milling', speed_factor: 1.1, feed_factor: 1.2, doc_factor: 0.5 },
            roughing: { name: 'Roughing', speed_factor: 0.9, feed_factor: 1.1, doc_factor: 1.2 },
            finishing: { name: 'Finishing', speed_factor: 1.3, feed_factor: 0.8, doc_factor: 0.3 }
        };
        
        // Application State
        let appState = {
            selectedMaterials: ['al_6061_t6'],
            selectedCutTypes: ['profile'],
            aggressiveness: 1.0,
            customDOC: null,
            machineConfig: ENHANCED_MACHINES.printnc,
            currentSpindle: { power_W: 2200, max_rpm: 24000, min_rpm: 8000 },
            currentTool: {
                type: 'endmill_flat',
                diameter_mm: 6.0,
                flutes: 2,
                stickout_mm: 25,
                material: 'carbide'
            }
        };
        
        // Enhanced Calculation Engine
        function calculateSpeedsFeeds(material, cutType, tool, machine, spindle, aggressiveness, customDOC) {
            const materialData = ENHANCED_MATERIALS[material];
            const cutData = ENHANCED_CUT_TYPES[cutType];
            
            // Determine aggressiveness level
            let aggressivenessLevel = 'moderate';
            if (aggressiveness < 0.7) aggressivenessLevel = 'conservative';
            else if (aggressiveness > 1.5) aggressivenessLevel = 'aggressive';
            
            // Get chipload range
            const chiploadRange = materialData.chipload_ranges[aggressivenessLevel];
            const targetChipload = (chiploadRange[0] + chiploadRange[1]) / 2 * aggressiveness;
            
            // Calculate RPM (surface speed based)
            const surfaceSpeed = getSurfaceSpeed(material, tool.type) * cutData.speed_factor;
            const rpm = Math.round((surfaceSpeed * 1000) / (Math.PI * tool.diameter_mm));
            const clampedRPM = Math.max(spindle.min_rpm, Math.min(rpm, spindle.max_rpm));
            
            // Calculate feed rate
            const feedRate = Math.round(clampedRPM * tool.flutes * targetChipload);
            const maxFeedRate = machine.max_feed_rate_mm_min * cutData.feed_factor;
            const clampedFeedRate = Math.min(feedRate, maxFeedRate);
            
            // Calculate DOC
            let doc = customDOC;
            if (!doc) {
                doc = Math.min(
                    tool.diameter_mm * 0.5 * cutData.doc_factor * aggressiveness,
                    materialData.max_doc_mm
                );
            }
            
            // Calculate power requirement
            const MRR = tool.diameter_mm * 0.5 * doc * clampedFeedRate; // mm³/min
            const power = Math.round((MRR * materialData.specific_cutting_energy_J_mm3) / 60);
            
            // Calculate actual chipload
            const actualChipload = clampedFeedRate / (clampedRPM * tool.flutes);
            
            // Generate warnings
            const warnings = generateWarnings(power, spindle.power_W, actualChipload, chiploadRange, doc, materialData.max_doc_mm);
            
            return {
                rpm: clampedRPM,
                feed_rate_mm_min: clampedFeedRate,
                chipload_mm: Math.round(actualChipload * 1000) / 1000,
                doc_mm: Math.round(doc * 100) / 100,
                power_W: power,
                warnings: warnings,
                status: warnings.length > 0 ? 'warning' : 'good'
            };
        }
        
        function getSurfaceSpeed(material, toolType) {
            const surfaceSpeeds = {
                al_6061_t6: { endmill_flat: 300, endmill_ball: 250, chamfer: 350, drill: 200 },
                steel_1018: { endmill_flat: 150, endmill_ball: 120, chamfer: 180, drill: 100 },
                steel_4140: { endmill_flat: 120, endmill_ball: 100, chamfer: 140, drill: 80 },
                stainless_316: { endmill_flat: 100, endmill_ball: 85, chamfer: 120, drill: 70 },
                titanium_6al4v: { endmill_flat: 80, endmill_ball: 70, chamfer: 90, drill: 50 },
                delrin: { endmill_flat: 400, endmill_ball: 350, chamfer: 450, drill: 300 },
                hardwood: { endmill_flat: 500, endmill_ball: 450, chamfer: 600, drill: 400 }
            };
            
            return surfaceSpeeds[material]?.[toolType] || 150;
        }
        
        function generateWarnings(power, maxPower, chipload, chiploadRange, doc, maxDoc) {
            const warnings = [];
            
            if (power > maxPower * 0.9) {
                warnings.push('High power requirement - reduce feed rate or DOC');
            }
            
            if (chipload < chiploadRange[0]) {
                warnings.push('Chipload too small - may cause work hardening');
            }
            
            if (chipload > chiploadRange[1]) {
                warnings.push('Chipload too large - may break tool');
            }
            
            if (doc > maxDoc) {
                warnings.push('DOC exceeds material recommendations');
            }
            
            return warnings;
        }
        
        // UI Update Functions
        function updateMachineConfig() {
            const machineType = document.getElementById('machineType').value;
            if (machineType !== 'custom') {
                appState.machineConfig = ENHANCED_MACHINES[machineType];
                
                // Update motor configuration display
                const machine = appState.machineConfig;
                document.getElementById('motorType').value = machine.motors.type;
                document.getElementById('motorTorque').value = machine.motors.torque_Nm;
                document.getElementById('maxRPM').value = machine.motors.max_rpm;
                
                updateCalculations();
            }
        }
        
        function updateMotorSpecs() {
            // Update calculations when motor specs change
            updateCalculations();
        }
        
        function updateSpindleConfig() {
            const spindleType = document.getElementById('spindleType').value;
            const spindleConfigs = {
                router_dewalt: { power_W: 700, max_rpm: 27000, min_rpm: 16000 },
                router_makita: { power_W: 710, max_rpm: 30000, min_rpm: 10000 },
                spindle_800w: { power_W: 800, max_rpm: 24000, min_rpm: 8000 },
                spindle_2200w: { power_W: 2200, max_rpm: 24000, min_rpm: 8000 },
                spindle_4000w: { power_W: 4000, max_rpm: 18000, min_rpm: 6000 }
            };
            
            if (spindleConfigs[spindleType]) {
                appState.currentSpindle = spindleConfigs[spindleType];
                document.getElementById('spindlePower').value = appState.currentSpindle.power_W;
            }
            
            updateCalculations();
        }
        
        function updateToolConfig() {
            const toolType = document.getElementById('toolType').value;
            appState.currentTool.type = toolType;
            
            // Update default parameters based on tool type
            const toolDefaults = {
                endmill_flat: { flutes: 2, diameter: 6.0 },
                endmill_ball: { flutes: 2, diameter: 6.0 },
                chamfer: { flutes: 2, diameter: 6.0 },
                vbit: { flutes: 1, diameter: 6.0 },
                drill: { flutes: 2, diameter: 6.0 },
                facemill: { flutes: 4, diameter: 20.0 }
            };
            
            if (toolDefaults[toolType]) {
                document.getElementById('toolFlutes').value = toolDefaults[toolType].flutes;
                if (toolType === 'facemill') {
                    document.getElementById('toolDiameter').value = toolDefaults[toolType].diameter;
                }
            }
            
            updateCalculations();
        }
        
        function toggleDOCOverride() {
            const enabled = document.getElementById('enableDOCOverride').checked;
            const controls = document.getElementById('docOverrideControls');
            const recommendations = document.getElementById('docRecommendations');
            
            if (enabled) {
                controls.style.display = 'block';
                recommendations.innerHTML = '<small><strong>Manual DOC Control Enabled</strong> - Monitor warnings carefully</small>';
                appState.customDOC = parseFloat(document.getElementById('customDOC').value);
            } else {
                controls.style.display = 'none';
                recommendations.innerHTML = '<small>Automatic DOC calculation based on tool and material properties</small>';
                appState.customDOC = null;
            }
            
            updateCalculations();
        }
        
        function updateAggressiveness(value) {
            appState.aggressiveness = parseFloat(value);
            document.getElementById('aggressivenessValue').textContent = value;
            updateCalculations();
        }
        
        function updateCalculations() {
            // Get current tool configuration
            appState.currentTool.diameter_mm = parseFloat(document.getElementById('toolDiameter').value);
            appState.currentTool.flutes = parseInt(document.getElementById('toolFlutes').value);
            appState.currentTool.stickout_mm = parseFloat(document.getElementById('toolStickout').value);
            
            // Get current spindle configuration
            appState.currentSpindle.power_W = parseFloat(document.getElementById('spindlePower').value);
            
            // Get custom DOC if enabled
            if (document.getElementById('enableDOCOverride').checked) {
                appState.customDOC = parseFloat(document.getElementById('customDOC').value);
            }
            
            // Calculate results for all selected combinations
            const results = [];
            const warnings = [];
            
            appState.selectedMaterials.forEach(material => {
                appState.selectedCutTypes.forEach(cutType => {
                    const result = calculateSpeedsFeeds(
                        material,
                        cutType,
                        appState.currentTool,
                        appState.machineConfig,
                        appState.currentSpindle,
                        appState.aggressiveness,
                        appState.customDOC
                    );
                    
                    result.material = material;
                    result.cutType = cutType;
                    results.push(result);
                    
                    if (result.warnings.length > 0) {
                        warnings.push(...result.warnings);
                    }
                });
            });
            
            // Update DOC warnings if manual override is enabled
            updateDOCWarnings();
            
            // Display results
            displayResults(results, warnings);
        }
        
        function updateDOCWarnings() {
            const warningsDiv = document.getElementById('docWarnings');
            if (!document.getElementById('enableDOCOverride').checked) {
                warningsDiv.innerHTML = '';
                return;
            }
            
            const customDOC = parseFloat(document.getElementById('customDOC').value);
            const warnings = [];
            
            // Check against material max DOC for selected materials
            appState.selectedMaterials.forEach(materialKey => {
                const material = ENHANCED_MATERIALS[materialKey];
                if (customDOC > material.max_doc_mm) {
                    warnings.push(`DOC exceeds ${material.name} recommendation (${material.max_doc_mm}mm)`);
                }
            });
            
            // Check against tool diameter
            const toolDiameter = parseFloat(document.getElementById('toolDiameter').value);
            if (customDOC > toolDiameter * 0.75) {
                warnings.push('DOC exceeds recommended tool diameter ratio');
            }
            
            if (warnings.length > 0) {
                warningsDiv.innerHTML = `<div class="warning">${warnings.join('<br>')}</div>`;
            } else {
                warningsDiv.innerHTML = '<div class="success">DOC is within recommended ranges</div>';
            }
        }
        
        function displayResults(results, warnings) {
            const container = document.getElementById('resultsContainer');
            const warningsContainer = document.getElementById('warningsContainer');
            const table = document.getElementById('resultsTable');
            const tableBody = document.getElementById('resultsTableBody');
            
            // Clear previous results
            tableBody.innerHTML = '';
            warningsContainer.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = '<div class="warning">No materials or cut types selected</div>';
                table.style.display = 'none';
                return;
            }
            
            // Show global warnings
            if (warnings.length > 0) {
                const uniqueWarnings = [...new Set(warnings)];
                warningsContainer.innerHTML = `<div class="warning"><strong>Warnings:</strong><br>${uniqueWarnings.join('<br>')}</div>`;
            }
            
            // Populate results table
            results.forEach(result => {
                const row = document.createElement('tr');
                const statusClass = result.status === 'warning' ? 'warning' : 'success';
                
                row.innerHTML = `
                    <td>${ENHANCED_MATERIALS[result.material].name}</td>
                    <td>${ENHANCED_CUT_TYPES[result.cutType].name}</td>
                    <td>${result.rpm}</td>
                    <td>${result.feed_rate_mm_min}</td>
                    <td>${result.chipload_mm}</td>
                    <td>${result.doc_mm}</td>
                    <td>${result.power_W}</td>
                    <td><span class="${statusClass}">${result.status === 'warning' ? '⚠️' : '✅'}</span></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            table.style.display = 'table';
            container.innerHTML = '';
        }
        
        // Export/Import Functions
        function exportSettings() {
            const settings = {
                version: '2.0',
                machine_config: appState.machineConfig,
                spindle_config: appState.currentSpindle,
                tool_config: appState.currentTool,
                selected_materials: appState.selectedMaterials,
                selected_cut_types: appState.selectedCutTypes,
                aggressiveness: appState.aggressiveness,
                custom_doc: appState.customDOC,
                exported_date: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'justthecihp-v2-settings.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function importSettings() {
            document.getElementById('importFile').click();
        }
        
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    
                    // Apply imported settings
                    if (settings.aggressiveness) {
                        appState.aggressiveness = settings.aggressiveness;
                        document.getElementById('aggressiveness').value = settings.aggressiveness;
                        document.getElementById('aggressivenessValue').textContent = settings.aggressiveness;
                    }
                    
                    if (settings.selected_materials) {
                        appState.selectedMaterials = settings.selected_materials;
                        updateMaterialCheckboxes();
                    }
                    
                    if (settings.selected_cut_types) {
                        appState.selectedCutTypes = settings.selected_cut_types;
                        updateCutTypeCheckboxes();
                    }
                    
                    if (settings.tool_config) {
                        document.getElementById('toolDiameter').value = settings.tool_config.diameter_mm;
                        document.getElementById('toolFlutes').value = settings.tool_config.flutes;
                        document.getElementById('toolStickout').value = settings.tool_config.stickout_mm;
                    }
                    
                    updateCalculations();
                    
                    alert('Settings imported successfully!');
                } catch (error) {
                    alert('Error importing settings: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // Initialize the application
        function initializeApp() {
            // Populate material selection
            const materialContainer = document.getElementById('materialSelection');
            Object.entries(ENHANCED_MATERIALS).forEach(([key, material]) => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="material_${key}" value="${key}" 
                           ${appState.selectedMaterials.includes(key) ? 'checked' : ''}
                           onchange="updateMaterialSelection('${key}', this.checked)">
                    <label for="material_${key}">${material.name}</label>
                `;
                if (appState.selectedMaterials.includes(key)) {
                    div.classList.add('selected');
                }
                materialContainer.appendChild(div);
            });
            
            // Populate cut type selection
            const cutTypeContainer = document.getElementById('cutTypeSelection');
            Object.entries(ENHANCED_CUT_TYPES).forEach(([key, cutType]) => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="cuttype_${key}" value="${key}"
                           ${appState.selectedCutTypes.includes(key) ? 'checked' : ''}
                           onchange="updateCutTypeSelection('${key}', this.checked)">
                    <label for="cuttype_${key}">${cutType.name}</label>
                `;
                if (appState.selectedCutTypes.includes(key)) {
                    div.classList.add('selected');
                }
                cutTypeContainer.appendChild(div);
            });
            
            // Initialize with default calculations
            updateCalculations();
        }
        
        function updateMaterialSelection(materialKey, checked) {
            const checkbox = document.getElementById(`material_${materialKey}`);
            const item = checkbox.closest('.checkbox-item');
            
            if (checked) {
                if (!appState.selectedMaterials.includes(materialKey)) {
                    appState.selectedMaterials.push(materialKey);
                }
                item.classList.add('selected');
            } else {
                appState.selectedMaterials = appState.selectedMaterials.filter(m => m !== materialKey);
                item.classList.remove('selected');
            }
            
            updateCalculations();
        }
        
        function updateCutTypeSelection(cutTypeKey, checked) {
            const checkbox = document.getElementById(`cuttype_${cutTypeKey}`);
            const item = checkbox.closest('.checkbox-item');
            
            if (checked) {
                if (!appState.selectedCutTypes.includes(cutTypeKey)) {
                    appState.selectedCutTypes.push(cutTypeKey);
                }
                item.classList.add('selected');
            } else {
                appState.selectedCutTypes = appState.selectedCutTypes.filter(c => c !== cutTypeKey);
                item.classList.remove('selected');
            }
            
            updateCalculations();
        }
        
        function updateMaterialCheckboxes() {
            Object.keys(ENHANCED_MATERIALS).forEach(materialKey => {
                const checkbox = document.getElementById(`material_${materialKey}`);
                const item = checkbox.closest('.checkbox-item');
                
                checkbox.checked = appState.selectedMaterials.includes(materialKey);
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        function updateCutTypeCheckboxes() {
            Object.keys(ENHANCED_CUT_TYPES).forEach(cutTypeKey => {
                const checkbox = document.getElementById(`cuttype_${cutTypeKey}`);
                const item = checkbox.closest('.checkbox-item');
                
                checkbox.checked = appState.selectedCutTypes.includes(cutTypeKey);
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>